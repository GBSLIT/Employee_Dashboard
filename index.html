<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Employee Dashboard - Live</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#f6f8fb; --card:#ffffff; --muted:#64748b;
      --accent:#2563eb; --radius:14px;
    }
    html,body,#root{height:100%; margin:0; font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;}
    body{background:linear-gradient(180deg,#f8fbff 0%,var(--bg) 100%); color:#0f172a;}
    .app { display:flex; min-height:100vh; }

    .sidebar {
      width:220px; background:rgba(255,255,255,0.92);
      box-shadow: 8px 0 24px rgba(15,23,42,0.03);
      padding:20px; border-right:1px solid #eef2f7;
      position:sticky; top:0; height:100vh; box-sizing:border-box;
    }

    .logo { font-weight:700; font-size:18px; margin-bottom:18px; }
    .nav { margin-top:18px; display:flex; flex-direction:column; gap:6px; }
    .nav button {
      text-align:left; background:none; border:none;
      padding:10px 12px; border-radius:10px;
      cursor:pointer; color:#0f172a; font-weight:500;
    }
    .nav button:hover{ background:#f1f5f9; }
    .nav .active{
      background:linear-gradient(90deg, rgba(37,99,235,0.1), rgba(80,123,255,0.03));
      color:var(--accent);
    }

    .main { flex:1; padding:28px; box-sizing:border-box; }
    .header { display:flex; justify-content:space-between; align-items:center; margin-bottom:18px; }
    .kpi-row { display:flex; gap:12px; flex-wrap:wrap; }
    .kpi {
      background:var(--card); border-radius:12px;
      padding:16px; box-shadow: 0 6px 18px rgba(15,23,42,0.04);
      min-width:170px;
    }
    .kpi .label{ color:var(--muted); font-size:12px; }
    .kpi .value{ font-size:20px; font-weight:700; margin-top:6px; }

    .card {
      background:var(--card); border-radius:12px;
      padding:16px; box-shadow: 0 8px 28px rgba(15,23,42,0.03);
      margin-top:16px;
    }

    .row { display:flex; gap:12px; }
    .col-2 { display:flex; flex-direction:column; gap:12px; flex:1; }
    table { width:100%; border-collapse:collapse; margin-top:12px; }
    th, td {
      text-align:left; padding:10px 8px;
      border-bottom:1px solid #f1f5f9;
      font-size:14px;
    }

    .muted { color:var(--muted); font-size:13px; }

    .btn {
      background:var(--accent); color:#fff;
      border:none; padding:8px 12px;
      border-radius:10px; cursor:pointer;
    }

    .search {
      padding:8px 12px; border-radius:10px;
      border:1px solid #eef2f7; width:220px;
    }

    .login-wrap {
      min-height:100vh;
      display:flex; align-items:center; justify-content:center;
    }
    .login-card {
      width:420px; background:var(--card);
      padding:28px; border-radius:16px;
      box-shadow: 0 12px 40px rgba(15,23,42,0.06);
    }
    .field { display:flex; flex-direction:column; gap:6px; margin-bottom:12px; }
    .input { padding:10px 12px; border-radius:10px; border:1px solid #e6eefb; }
    .small { font-size:13px; color:var(--muted); }

    .tabbar { display:flex; gap:8px; margin-top:12px; }
    .tab {
      padding:8px 12px; border-radius:10px;
      background:#f8fafc; cursor:pointer;
      font-weight:600;
    }
    .tab.active {
      background:linear-gradient(90deg,#eef2ff,#fff);
      color:var(--accent);
      box-shadow:0 6px 18px rgba(37,99,235,0.06);
    }

    .link-btn { background:none; border:none; color:var(--accent); cursor:pointer; padding:0; font-weight:600; }
    footer { margin-top:24px; color:var(--muted); font-size:13px; }

    .pw-row { display:flex; gap:8px; align-items:center; }
    .pw-toggle { background:none; border:none; cursor:pointer; padding:6px; border-radius:8px; }
    .notice { font-size:13px; color:#065f46; background:#ecfdf5; padding:8px 10px; border-radius:8px; border:1px solid #bbf7d0; margin-top:8px; }

    @media (max-width:900px){
      .sidebar{display:none;}
      .main{padding:14px;}
      .row{flex-direction:column;}
      .kpi{min-width:140px;}
    }
  </style>
</head>

<body>
<div id="root"></div>

<!-- === MSAL UMD + OneDrive Graph helper (non-module, UMD build) ===
     This replaces the module approach and avoids import problems when served
     over http(s). Keep this block and remove any other msal module script. -->
<script src="https://cdn.jsdelivr.net/npm/@azure/msal-browser@2.38.0/dist/msal-browser.min.js"></script>
<script>
(function(){
  // --- REPLACE THESE with your values ---
  const CLIENT_ID = "accad762-6c84-4b00-a9d6-98ddacb8e789";
  const TENANT_ID = "93846c24-8666-4033-8b6e-901877a2cf98";
  const REDIRECT_URI = "https://gbslit.github.io/Employee_Dashboard/"; // e.g. "https://yourusername.github.io/yourrepo/" or "http://localhost:8000/"
  const DRIVE_ID = "b!btaPqJ-5kU-kkE4KEoaxo8fltt6l6xpLs60U3YTj_EAxQMgJa8fsSLceYscvhxNo";
  const FILE_ID  = "16GCLEJF6QPT4M3PLEFEITOFBJOBB4R2E";
  const TABLES = {
    employees: "Employees",
    attendance: "Attendance",
    leaves: "Leaves",
    payroll: "Payroll",
    htm: "HTM_LeaveCodes"
  };
  // ---------------------------------------

  if (!window.msal || typeof window.msal.PublicClientApplication !== 'function') {
    console.error('MSAL UMD not loaded. Check network or CDN blocking.');
    return;
  }

  const msalInstance = new msal.PublicClientApplication({
    auth: {
      clientId: CLIENT_ID,
      authority: 'https://login.microsoftonline.com/' + TENANT_ID,
      redirectUri: REDIRECT_URI
    },
    cache: { cacheLocation: "sessionStorage" }
  });

  const SCOPES = ["Files.Read.All","User.Read","Sites.Read.All"];

  async function getToken() {
    const accounts = msalInstance.getAllAccounts();
    if (accounts.length === 0) {
      await msalInstance.loginPopup({ scopes: SCOPES });
    }
    const account = msalInstance.getAllAccounts()[0];
    try {
      const result = await msalInstance.acquireTokenSilent({ scopes: SCOPES, account });
      return result.accessToken;
    } catch (err) {
      const result = await msalInstance.acquireTokenPopup({ scopes: SCOPES });
      return result.accessToken;
    }
  }

  window.fetchOneDriveTable = async function(tableKeyOrName) {
    const tableName = TABLES[tableKeyOrName] || tableKeyOrName;
    const token = await getToken();
    const base = `https://graph.microsoft.com/v1.0/drives/${DRIVE_ID}/items/${FILE_ID}/workbook`;

    // fetch columns
    const colRes = await fetch(`${base}/tables/${encodeURIComponent(tableName)}/columns`, {
      headers: { Authorization: 'Bearer ' + token }
    });
    if(!colRes.ok) {
      const txt = await colRes.text().catch(()=>'');
      throw new Error('Columns fetch failed: ' + colRes.status + ' ' + txt);
    }
    const colJson = await colRes.json();
    const columns = (colJson.value || []).map(c => c.name);

    // fetch rows
    const rowRes = await fetch(`${base}/tables/${encodeURIComponent(tableName)}/rows`, {
      headers: { Authorization: 'Bearer ' + token }
    });
    if(!rowRes.ok) {
      const txt = await rowRes.text().catch(()=>'');
      throw new Error('Rows fetch failed: ' + rowRes.status + ' ' + txt);
    }
    const rowJson = await rowRes.json();
    const rows = (rowJson.value || []).map(r => {
      const vals = (r.values && r.values[0]) ? r.values[0] : [];
      const obj = {};
      for (let i=0;i<columns.length;i++) obj[columns[i]] = vals[i] ?? null;
      return obj;
    });
    return rows;
  };

  window.msalOneDrive = {
    msalInstance,
    loginPopup: async () => msalInstance.loginPopup({ scopes: SCOPES }),
    getAccount: () => msalInstance.getAllAccounts()[0] || null
  };

  console.info('fetchOneDriveTable helper initialized (UMD).');
})();
</script>
<!-- === end MSAL UMD helper === -->

<!-- React UMD -->
<script src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
<!-- Babel compiler -->
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<script type="text/babel">
const { useState } = React;

/* ---------------------------------------
   LOGIN PAGE (EMPID + Password validated against OneDrive Employees table)
--------------------------------------- */
function LoginPage({ onLogin, onShowForgot }) {
  const [employeeId, setEmployeeId] = useState('');
  const [password, setPassword] = useState('');
  const [showPassword, setShowPassword] = useState(false);
  const [error, setError] = useState('');
  const [loading, setLoading] = useState(false);

  async function submit(e){
    e.preventDefault();
    setError('');
    if(!employeeId.trim() || !password){
      setError('Please enter Employee ID and Password');
      return;
    }

    setLoading(true);
    try {
      if(typeof window.fetchOneDriveTable !== 'function') {
        throw new Error('fetchOneDriveTable helper not available. Possible causes: 1) The ES module failed to load, 2) You opened the page via file:// (use http(s) or GitHub Pages), 3) CDN or network blocked the msal import. Open DevTools Console for the full module error.');
      }
      // fetch employees table live from OneDrive
      const rows = await window.fetchOneDriveTable('employees');
      // normalize keys: check variants
      const match = (rows || []).find(r => {
        const id = (r.employeeId || r.EmployeeID || r['Employee ID'] || r.id || r.ID || '').toString().trim().toLowerCase();
        const pw = (r.password || r.Password || '').toString();
        return id === employeeId.trim().toLowerCase() && pw === password;
      });

      if(!match) {
        setError('Invalid Employee ID or Password.');
        setLoading(false);
        return;
      }

      const canonicalId = (match.employeeId || match.EmployeeID || match['Employee ID'] || match.id || match.ID);
      onLogin(canonicalId.toString());
    } catch (err) {
      console.error('Login/Employees fetch error', err);
      setError('Login failed: ' + (err.message || 'Unable to fetch employees'));
    } finally {
      setLoading(false);
    }
  }

  return (
    <div className="login-wrap">
      <div className="login-card">
        <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:12}}>
          <div style={{fontSize:20,fontWeight:700}}>Company HR</div>
          <div style={{color:'var(--muted)',fontSize:13}}>Live login</div>
        </div>

        <h2 style={{marginTop:6}}>Employee Sign In</h2>
        <p className="small">Enter your Employee ID & Password</p>

        <form onSubmit={submit} style={{marginTop:12}}>
          <div className="field">
            <label className="small">Employee ID</label>
            <input className="input" value={employeeId} onChange={(e)=>{setEmployeeId(e.target.value); setError('')}} placeholder="e.g. GBSL1015" />
          </div>

          <div className="field">
            <label className="small">Password</label>
            <div className="pw-row">
              <input
                className="input"
                style={{flex:1}}
                type={showPassword ? 'text' : 'password'}
                value={password}
                onChange={(e)=>{setPassword(e.target.value); setError('')}}
                placeholder="Enter password"
              />
              <button type="button" aria-label="Toggle password visibility" className="pw-toggle" onClick={()=>setShowPassword(s=>!s)}>
                {showPassword ? 'üôà' : 'üëÅÔ∏è'}
              </button>
            </div>
          </div>

          {error && <div style={{color:'#dc2626',fontSize:13,marginTop:6}}>{error}</div>}

          <div style={{display:'flex', gap:8, justifyContent:'space-between', alignItems:'center', marginTop:12}}>
            <button className="btn" disabled={loading}>{loading ? 'Signing in...' : 'Sign in'}</button>
            <div style={{display:'flex',gap:10,alignItems:'center'}}>
              <button type="button" className="link-btn" onClick={() => onShowForgot(true)}>Forgot?</button>
              <div className="small">Try: GBSL1015 / SADIQ</div>
            </div>
          </div>
        </form>

        <footer style={{marginTop:16}} className="small muted">Live mode ‚Äî authenticate using OneDrive Employees table.</footer>
      </div>
    </div>
  );
}

/* ---------------------------------------
   Forgot Password (demo: reset in-memory local)
--------------------------------------- */
function ForgotPassword({ onDone }) {
  const [employeeId, setEmployeeId] = useState('');
  const [newPw, setNewPw] = useState('');
  const [confirm, setConfirm] = useState('');
  const [msg, setMsg] = useState('');
  const [error, setError] = useState('');

  async function submit(e){
    e.preventDefault();
    setError(''); setMsg('');

    if(!employeeId.trim() || !newPw || !confirm){
      setError('Please fill all fields.');
      return;
    }
    if(newPw !== confirm){
      setError('Passwords do not match.');
      return;
    }

    setMsg('Password reset is not available in this demo. Contact HR to reset your password.');
    setEmployeeId(''); setNewPw(''); setConfirm('');
  }

  return (
    <div className="login-wrap">
      <div className="login-card">
        <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:12}}>
          <div style={{fontSize:20,fontWeight:700}}>Reset Password</div>
          <div style={{color:'var(--muted)',fontSize:13}}>Demo flow</div>
        </div>

        <p className="small">Enter your Employee ID and a new password. In this demo we do not write back to the Excel file.</p>

        <form onSubmit={submit} style={{marginTop:12}}>
          <div className="field">
            <label className="small">Employee ID</label>
            <input className="input" value={employeeId} onChange={(e)=>{setEmployeeId(e.target.value); setError(''); setMsg('')}} placeholder="e.g. GBSL1015" />
          </div>

          <div className="field">
            <label className="small">New Password</label>
            <input className="input" type="password" value={newPw} onChange={(e)=>{setNewPw(e.target.value); setError(''); setMsg('')}} placeholder="New password" />
          </div>

          <div className="field">
            <label className="small">Confirm Password</label>
            <input className="input" type="password" value={confirm} onChange={(e)=>{setConfirm(e.target.value); setError(''); setMsg('')}} placeholder="Confirm password" />
          </div>

          {error && <div style={{color:'#dc2626',fontSize:13,marginTop:6}}>{error}</div>}
          {msg && <div className="notice">{msg}</div>}

          <div style={{display:'flex', gap:8, justifyContent:'space-between', alignItems:'center', marginTop:12}}>
            <button className="btn">Update Password</button>
            <button type="button" className="link-btn" onClick={()=>onDone()}>Back to sign in</button>
          </div>
        </form>

        <footer style={{marginTop:16}} className="small muted">Demo only ‚Äî no changes made to OneDrive.</footer>
      </div>
    </div>
  );
}

/* ---------------------------------------
   Dashboard components (unchanged)
--------------------------------------- */
function Sidebar({ current, onSelect, onLogout }) {
  const tabs = ['Overview','Attendance','Leaves','Payroll','HTM Codes','Profile'];
  return (
    <div className="sidebar">
      <div className="logo">Acme Corp</div>
      <div className="muted">Employee Dashboard</div>
      <div className="nav">
        {tabs.map(t=>(
          <button key={t} className={current===t ? 'active' : ''} onClick={()=>onSelect(t)}>{t}</button>
        ))}
      </div>
      <div style={{marginTop:'auto', marginBottom:8}} className="small muted">Signed in as <strong>Demo user</strong></div>
      <button onClick={onLogout} className="btn" style={{width:'100%'}}>Sign out</button>
    </div>
  );
}
function KPICard({label, value}) { return <div className="kpi"><div className="label">{label}</div><div className="value">{value}</div></div>; }

function Overview({ employees, attendance, leaves, payroll }) {
  return (
    <div>
      <div className="kpi-row">
        <KPICard label="Total Employees" value={employees.length} />
        <KPICard label="Present Today" value={attendance.filter(a=>a.status==='Present').length} />
        <KPICard label="Pending Leaves" value={leaves.filter(l=>l.status==='Pending').length} />
        <KPICard label="Payroll Runs" value={payroll.length} />
      </div>

      <div className="row" style={{marginTop:12}}>
        <div className="col-2">
          <div className="card">
            <strong>Attendance Snapshot</strong>
            <p className="muted">Latest attendance records</p>
            <table><thead><tr><th>Employee</th><th>Status</th><th>Time In</th><th>Time Out</th></tr></thead>
            <tbody>
              {attendance.map((r,i)=>(<tr key={i}><td>{r.name}</td><td>{r.status}</td><td>{r.timeIn}</td><td>{r.timeOut}</td></tr>))}
            </tbody></table>
          </div>

          <div className="card">
            <strong>Recent Leaves</strong>
            <p className="muted">Pending leave requests</p>
            <table><thead><tr><th>Employee</th><th>From</th><th>To</th><th>Status</th></tr></thead>
            <tbody>
              {leaves.map((l,i)=>(<tr key={i}><td>{l.name}</td><td>{l.start}</td><td>{l.end}</td><td>{l.status}</td></tr>))}
            </tbody></table>
          </div>
        </div>

        <div style={{width:320}}>
          <div className="card">
            <strong>Payroll Summary</strong>
            <p className="muted">Last payrolls</p>
            <table><thead><tr><th>Employee</th><th>Net</th><th>Status</th></tr></thead>
            <tbody>{payroll.map((p,i)=>(<tr key={i}><td>{p.name}</td><td>${p.net}</td><td>{p.status}</td></tr>))}</tbody></table>
          </div>

          <div className="card" style={{marginTop:12}}>
            <strong>HTM Codes</strong>
            <p className="muted">Leave code mapping</p>
            <table><thead><tr><th>Code</th><th>Desc</th></tr></thead>
            <tbody>{/* HTM will be passed into HTMTab separately */}</tbody></table>
          </div>
        </div>
      </div>
    </div>
  );
}

function AttendanceTab({attendance}) {
  const [filter, setFilter] = useState('All');
  const [q, setQ] = useState('');
  const rows = attendance.filter(r => (filter==='All' || r.status===filter) && ((r.name||'').toLowerCase().includes(q.toLowerCase()) || ((r.employeeId||'').toLowerCase().includes(q.toLowerCase()))));
  return (
    <div>
      <div style={{display:'flex', justifyContent:'space-between', alignItems:'center'}}>
        <div className="tabbar">
          {['All','Present','WFH','On Leave','Absent'].map(t=>(
            <div key={t} className={`tab ${t===filter?'active':''}`} onClick={()=>setFilter(t)}>{t}</div>
          ))}
        </div>
        <div>
          <input className="search" placeholder="Search by name or id" value={q} onChange={(e)=>setQ(e.target.value)} />
        </div>
      </div>

      <div className="card" style={{marginTop:12}}>
        <table>
          <thead><tr><th>Employee</th><th>ID</th><th>Status</th><th>Date</th><th>In</th><th>Out</th></tr></thead>
          <tbody>
            {rows.map((r,i)=>(
              <tr key={i}>
                <td>{r.name}</td><td>{r.employeeId}</td><td>{r.status}</td><td>{r.date}</td><td>{r.timeIn}</td><td>{r.timeOut}</td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  );
}

function LeavesTab({leaves}) {
  return (
    <div>
      <div style={{display:'flex', justifyContent:'space-between', alignItems:'center'}}>
        <h3>Leaves</h3>
        <button className="btn" onClick={()=>alert('Open apply leave form (demo)')}>Apply Leave</button>
      </div>
      <div className="card">
        <table>
          <thead><tr><th>Employee</th><th>From</th><th>To</th><th>Type</th><th>Status</th></tr></thead>
          <tbody>{leaves.map((l,i)=>(<tr key={i}><td>{l.name}</td><td>{l.start}</td><td>{l.end}</td><td>{l.type}</td><td>{l.status}</td></tr>))}</tbody>
        </table>
      </div>
    </div>
  );
}

function PayrollTab({payroll}) {
  return (
    <div>
      <div style={{display:'flex', justifyContent:'space-between', alignItems:'center'}}>
        <h3>Payroll</h3>
        <button className="btn" onClick={()=>alert('Run payroll (demo)')}>Run Payroll</button>
      </div>
      <div className="card">
        <table>
          <thead><tr><th>Employee</th><th>Pay Period</th><th>Gross</th><th>Net</th><th>Status</th></tr></thead>
          <tbody>{payroll.map((p,i)=>(<tr key={i}><td>{p.name}</td><td>{p.period}</td><td>${p.gross}</td><td>${p.net}</td><td>{p.status}</td></tr>))}</tbody>
        </table>
      </div>
    </div>
  );
}

function HTMTab({ htm }) {
  return (
    <div>
      <h3>HTM Codes</h3>
      <div className="card">
        <table>
          <thead><tr><th>Code</th><th>Description</th><th>Eligibility</th></tr></thead>
          <tbody>{(htm||[]).map((h,i)=>(<tr key={i}><td>{h.code}</td><td>{h.description}</td><td>{h.eligibility}</td></tr>))}</tbody>
        </table>
      </div>
    </div>
  );
}

function ProfileTab({employee}) {
  if(!employee) return <div className="card">Employee not found</div>;
  return (
    <div>
      <div className="card" style={{display:'flex', gap:16, alignItems:'center'}}>
        <div style={{width:92,height:92,borderRadius:10, background:'#eef2ff', display:'flex',alignItems:'center',justifyContent:'center',fontWeight:700,fontSize:22,color:'var(--accent)'}}>{(employee.name||'').split(' ').map(n=>n[0]).slice(0,2).join('')}</div>
        <div>
          <div style={{fontSize:18,fontWeight:700}}>{employee.name}</div>
          <div className="muted">{employee.title} ‚Ä¢ {employee.location}</div>
          <div style={{marginTop:8}} className="small">Email: {employee.email}</div>
          <div className="small">Employee ID: {employee.id}</div>
          <div style={{marginTop:8}}><strong>Leave Balance:</strong> {employee.leaveBalance} days</div>
        </div>
      </div>

      <div className="card">
        <h4>Quick Actions</h4>
        <div style={{display:'flex', gap:8, marginTop:8}}>
          <button className="btn" onClick={()=>alert('Mark attendance (demo)')}>Mark Attendance</button>
          <button className="btn" style={{background:'#06b6d4'}} onClick={()=>alert('Apply leave (demo)')}>Apply Leave</button>
        </div>
      </div>
    </div>
  );
}

/* ---------------------- Top-level App ---------------------- */
function App() {
  const [user, setUser] = useState(null); // store employeeId
  const [activeTab, setActiveTab] = useState('Overview');
  const [showForgot, setShowForgot] = useState(false);

  // Data - now stateful to be replaced with live OneDrive values
  const [employees, setEmployees] = useState([]);
  const [attendance, setAttendance] = useState([]);
  const [leaves, setLeaves] = useState([]);
  const [payroll, setPayroll] = useState([]);
  const [htm, setHtm] = useState([]);

  async function loadLiveDataFor(employeeId) {
    try {
      if(typeof window.fetchOneDriveTable !== 'function') {
        throw new Error('fetchOneDriveTable helper not available (see console).');
      }

      const empRows = await window.fetchOneDriveTable('employees').catch(()=>null);
      if(empRows && empRows.length) {
        setEmployees(empRows.map(r => ({
          id: r.employeeId || r.EmployeeID || r['Employee ID'] || r.id || r.ID,
          name: r.name || r.Name || r.FullName,
          email: r.email || r.Email,
          title: r.title || r.Title,
          location: r.location || r.Location,
          leaveBalance: r.leaveBalance || r.LeaveBalance || r.leave_balance || 0
        })));
      }

      const attRows = await window.fetchOneDriveTable('attendance').catch(()=>null);
      if(attRows && attRows.length) {
        setAttendance(attRows.map(r=>({
          employeeId: r.employeeId || r.EmployeeID || r['Employee ID'] || r.id,
          name: r.name || r.Name,
          date: r.date || r.Date,
          status: r.status || r.Status,
          timeIn: r.timeIn || r.TimeIn || r['Time In'] || '-',
          timeOut: r.timeOut || r.TimeOut || r['Time Out'] || '-'
        })));
      }

      const leavesRows = await window.fetchOneDriveTable('leaves').catch(()=>null);
      if(leavesRows && leavesRows.length) {
        setLeaves(leavesRows.map(r=>({
          leaveId: r.leaveId || r.LeaveID || r['Leave ID'],
          employeeId: r.employeeId || r.EmployeeID || r['Employee ID'],
          name: r.name || r.Name,
          start: r.startDate || r.Start || r.start,
          end: r.endDate || r.End || r.end,
          type: r.type || r.Type,
          status: r.status || r.Status,
          htmCode: r.htmCode || r.HTMCode
        })));
      }

      const payrollRows = await window.fetchOneDriveTable('payroll').catch(()=>null);
      if(payrollRows && payrollRows.length) {
        setPayroll(payrollRows.map(r=>({
          employeeId: r.employeeId || r.EmployeeID || r['Employee ID'],
          name: r.name || r.Name,
          period: r.period || (r.payPeriodStart && r.payPeriodEnd ? `${r.payPeriodStart} - ${r.payPeriodEnd}` : r.period),
          gross: r.gross || r.Gross || 0,
          net: r.net || r.Net || 0,
          status: r.status || r.Status
        })));
      }

      const htmRows = await window.fetchOneDriveTable('htm').catch(()=>null);
      if(htmRows && htmRows.length) {
        setHtm(htmRows.map(r=>({
          code: r.code || r.Code || r.HTM || r['HTM Code'],
          description: r.description || r.Description,
          eligibility: r.eligibility || r.Eligibility
        })));
      }
    } catch (err) {
      console.error('Live data load failed', err);
      // keep arrays empty if load fails
    }
  }

  function handleLogin(employeeId){
    setUser(employeeId);
    setActiveTab('Overview');
    setShowForgot(false);
    loadLiveDataFor(employeeId);
  }
  function handleLogout(){ setUser(null); setActiveTab('Overview'); setShowForgot(false); }

  if(!user){
    if(showForgot){
      return <ForgotPassword onDone={()=>setShowForgot(false)} />;
    }
    return <LoginPage onLogin={handleLogin} onShowForgot={setShowForgot} />;
  }

  const employee = (employees.find(e => (e.id || '').toString().toLowerCase() === (user||'').toString().toLowerCase())) || { id:user, name: user, email:`${user}@example.com`, title:'Employee', location:'‚Äî', leaveBalance:0 };

  return (
    <div className="app">
      <Sidebar current={activeTab} onSelect={setActiveTab} onLogout={handleLogout} />
      <div className="main">
        <div className="header">
          <div>
            <div style={{fontSize:22,fontWeight:700}}>Employee Dashboard ‚Äî Global</div>
            <div className="muted">Central dashboard for attendance, leaves and payroll</div>
          </div>
          <div style={{display:'flex', gap:12, alignItems:'center'}}>
            <div className="small muted">Locale: Global</div>
            <button className="btn" onClick={()=>alert('Open quick login modal (demo)')}>Employee Login</button>
          </div>
        </div>

        {/* Main content area */}
        {activeTab === 'Overview' && <Overview employees={employees} attendance={attendance} leaves={leaves} payroll={payroll} />}
        {activeTab === 'Attendance' && <AttendanceTab attendance={attendance} />}
        {activeTab === 'Leaves' && <LeavesTab leaves={leaves} />}
        {activeTab === 'Payroll' && <PayrollTab payroll={payroll} />}
        {activeTab === 'HTM Codes' && <HTMTab htm={htm} />}
        {activeTab === 'Profile' && <ProfileTab employee={employee} />}

        <footer>
          <div className="muted">Live ‚Äî Data is read from OneDrive Excel (if available).</div>
        </footer>
      </div>
    </div>
  );
}

/* Render app */
ReactDOM.createRoot(document.getElementById("root")).render(<App />);
</script>

</body>
</html>
