<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Employee Dashboard - Live</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    /* minimal styles - keep same look as yours if desired */
    body { font-family: Inter, Arial, sans-serif; background:#f6f8fb; color:#0f172a; margin:0; padding:18px; }
    .card{ background:#fff;padding:18px;border-radius:12px;box-shadow:0 8px 24px rgba(15,23,42,0.06); max-width:920px;margin:12px auto;}
    label{display:block;margin-top:8px;font-weight:600}
    input{padding:8px;border-radius:8px;border:1px solid #e6eefb;width:100%}
    button{margin-top:12px;padding:10px 14px;border-radius:8px;background:#2563eb;color:white;border:none;cursor:pointer}
    .diag{color:#b91c1c;margin-top:10px}
    .kpis{display:flex;gap:12px;margin-top:12px}
    .kpi{flex:1;background:#f8fbff;padding:12px;border-radius:8px;text-align:center}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{border-bottom:1px solid #eef2f7;padding:8px;text-align:left}
  </style>
</head>
<body>

<div class="card">
  <h2>Employee Dashboard — Live</h2>

  <div id="statusLine">Initializing...</div>

  <div style="margin-top:12px">
    <label>Employee ID</label>
    <input id="empId" placeholder="e.g. GBSL1015" />
    <label>Password (sheet-stored password)</label>
    <input id="empPw" placeholder="Enter password" type="password" />
    <div style="display:flex;gap:8px">
      <button id="signInBtn">Sign in (Live)</button>
      <button id="logoutBtn" style="background:#ef4444; display:none">Sign out</button>
    </div>
    <div id="diag" class="diag"></div>
  </div>

  <div id="dashboardArea" style="display:none">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3 id="welcome">Welcome</h3>
      <div>
        <button id="applyLeave">Apply Leave</button>
        <button id="markAttendance" style="background:#06b6d4">Mark Attendance</button>
      </div>
    </div>

    <div class="kpis">
      <div class="kpi"><div>Total Employees</div><div id="totalEmployees">—</div></div>
      <div class="kpi"><div>Present Today</div><div id="presentToday">—</div></div>
      <div class="kpi"><div>Pending Leaves</div><div id="pendingLeaves">—</div></div>
    </div>

    <h4>Attendance (latest)</h4>
    <table id="attendanceTable"><thead><tr><th>Employee</th><th>Status</th><th>In</th><th>Out</th></tr></thead><tbody></tbody></table>

    <h4>Leaves</h4>
    <table id="leavesTable"><thead><tr><th>Employee</th><th>From</th><th>To</th><th>Type</th><th>Status</th></tr></thead><tbody></tbody></table>

    <h4>Profile</h4>
    <table id="profileTable"><tbody></tbody></table>
  </div>
</div>

<script>
/* --------------- CONFIG - REPLACE these with your values ----------------- */
const CLIENT_ID = "ab387506-c162-4abf-8ca0-ea974f1e6e0c";
const TENANT_ID = "93846c24-8666-4033-8b6e-901877a2cf98";
const REDIRECT_URI = "https://gbslit.github.io/Employee_Dashboard/"; // exact URL registered in Azure (e.g. https://yourusername.github.io/yourrepo/)
const DRIVE_ID = "b!btaPqJ-5kU-kkE4KEoaxo8fltt6l6xpLs60U3YTj_EAxQMgJa8fsSLceYscvhxNo";
const FILE_ID  = "16GCLEJF6QPT4M3PLEFEITOFBJOBB4R2E";
/* table names in workbook */
const TABLES = { employees: "Employees", attendance: "Attendance", leaves: "Leaves", htm: "HTM_LeaveCodes" };
/* ------------------------------------------------------------------------ */

/* Dynamic diagnostics + robust MSAL loader with fallback CDNs */
const diag = (msg) => { document.getElementById('diag').textContent = msg; };
document.getElementById('statusLine').textContent = 'Loading msal...';

const MSAL_CDNS = [
  "https://cdn.jsdelivr.net/npm/@azure/msal-browser@2.38.0/dist/msal-browser.min.js",
  "https://unpkg.com/@azure/msal-browser@2.38.0/dist/msal-browser.min.js"
];

function loadScript(url, timeout = 10000){
  return new Promise((resolve, reject) => {
    const s = document.createElement('script');
    s.src = url;
    s.async = true;
    s.onload = () => resolve(url);
    s.onerror = () => reject(new Error('Script load error: ' + url));
    document.head.appendChild(s);
    setTimeout(()=>reject(new Error('Script load timeout: ' + url)), timeout);
  });
}

async function loadMsal() {
  let lastError = null;
  for (const u of MSAL_CDNS) {
    try {
      await loadScript(u);
      if(window.msal && typeof window.msal.PublicClientApplication === 'function') {
        console.info('MSAL loaded from', u);
        return;
      }
      lastError = new Error('MSAL loaded but PublicClientApplication not found: ' + u);
    } catch (e) {
      lastError = e;
    }
  }
  throw lastError || new Error('Failed to load MSAL from all CDNs');
}

/* Initialize msal + helper that reads Excel tables via Graph */
let msalInstance = null;
const SCOPES = ["Files.Read.All","User.Read","Sites.Read.All"];

async function initMsalAndHelpers(){
  try {
    await loadMsal();
  } catch (e) {
    console.error(e);
    diag('Init error: ' + e.message + '. Possible causes: page opened via file://, redirect URI mismatch in Azure, or CDN/network blocked MSAL. Check console for details.');
    document.getElementById('statusLine').textContent = 'Initialization failed';
    return;
  }

  msalInstance = new window.msal.PublicClientApplication({
    auth: { clientId: CLIENT_ID, authority: 'https://login.microsoftonline.com/' + TENANT_ID, redirectUri: REDIRECT_URI },
    cache: { cacheLocation: 'sessionStorage' }
  });

  async function getToken() {
    const accounts = msalInstance.getAllAccounts();
    if(accounts.length === 0){
      await msalInstance.loginPopup({ scopes: SCOPES });
    }
    const acc = msalInstance.getAllAccounts()[0];
    try {
      const tr = await msalInstance.acquireTokenSilent({ scopes: SCOPES, account: acc });
      return tr.accessToken;
    } catch (err) {
      const tr = await msalInstance.acquireTokenPopup({ scopes: SCOPES });
      return tr.accessToken;
    }
  }

  window.fetchOneDriveTable = async function(tableKeyOrName){
    if(!CLIENT_ID || CLIENT_ID.startsWith('REPLACE')) throw new Error('CLIENT_ID/TENANT_ID/REDIRECT_URI not configured');
    const tableName = TABLES[tableKeyOrName] || tableKeyOrName;
    const token = await getToken();
    const base = `https://graph.microsoft.com/v1.0/drives/${DRIVE_ID}/items/${FILE_ID}/workbook`;
    // columns
    const colRes = await fetch(`${base}/tables/${encodeURIComponent(tableName)}/columns`, { headers: { Authorization: 'Bearer ' + token }});
    if(!colRes.ok){ const t = await colRes.text().catch(()=>''); throw new Error('Columns fetch failed: ' + colRes.status + ' ' + t); }
    const colJson = await colRes.json();
    const columns = (colJson.value||[]).map(c=>c.name);
    // rows
    const rowRes = await fetch(`${base}/tables/${encodeURIComponent(tableName)}/rows`, { headers: { Authorization: 'Bearer ' + token }});
    if(!rowRes.ok){ const t = await rowRes.text().catch(()=>''); throw new Error('Rows fetch failed: ' + rowRes.status + ' ' + t); }
    const rowJson = await rowRes.json();
    const rows = (rowJson.value||[]).map(r => {
      const vals = (r.values && r.values[0]) ? r.values[0] : [];
      const obj = {};
      for(let i=0;i<columns.length;i++) obj[columns[i]] = vals[i] ?? null;
      return obj;
    });
    return rows;
  };

  window.msalOneDrive = {
    msalInstance,
    loginPopup: async () => msalInstance.loginPopup({ scopes: SCOPES }),
    getAccount: () => msalInstance.getAllAccounts()[0] || null
  };

  document.getElementById('statusLine').textContent = 'MSAL ready';
  console.info('fetchOneDriveTable helper ready');
}

/* -------------------- UI behaviour -------------------- */
document.getElementById('signInBtn').addEventListener('click', async () => {
  diag('');
  document.getElementById('statusLine').textContent = 'Signing in and fetching live data...';
  const id = document.getElementById('empId').value.trim();
  const pw = document.getElementById('empPw').value;
  if(!id || !pw) { diag('Enter ID and Password'); return; }

  if(typeof window.fetchOneDriveTable !== 'function') {
    diag('fetchOneDriveTable helper not available. See console for init errors.');
    return;
  }

  try {
    // load employees table live
    const empRows = await window.fetchOneDriveTable('employees');
    // find employee row match
    const match = (empRows || []).find(r => {
      const candidateId = (r.EmployeeId || r.EmployeeID || r['Employee ID'] || r['Employee Id'] || r.id || r.ID || '').toString().trim().toLowerCase();
      const candidatePw = (r.password || r.Password || '').toString();
      return candidateId === id.toLowerCase() && candidatePw === pw;
    });

    if(!match){
      diag('Invalid Employee ID or Password (checked against Employees table)');
      return;
    }

    // success
    showDashboardFor(match);
    document.getElementById('logoutBtn').style.display = 'inline-block';
  } catch (err) {
    console.error(err);
    diag('Login failed: ' + (err.message || err));
  } finally {
    document.getElementById('statusLine').textContent = 'Ready';
  }
});

document.getElementById('logoutBtn').addEventListener('click', () => {
  if(msalInstance){
    msalInstance.logoutPopup().catch(()=>{}); // best-effort
  }
  window.location.reload();
});

/* Render dashboard (after successful login) */
async function showDashboardFor(empRow){
  document.getElementById('dashboardArea').style.display = 'block';
  document.getElementById('welcome').textContent = `Welcome ${empRow.Name || empRow.name || empRow['Emp Name'] || ''}`;

  // fetch other tables concurrently (attendance, leaves, etc.)
  try {
    const [attendanceRows, leavesRows, empRows, htmRows] = await Promise.all([
      window.fetchOneDriveTable('attendance').catch(()=>[]),
      window.fetchOneDriveTable('leaves').catch(()=>[]),
      window.fetchOneDriveTable('employees').catch(()=>[]),
      window.fetchOneDriveTable('htm').catch(()=>[])
    ]);

    // fill KPIs
    document.getElementById('totalEmployees').textContent = (empRows || []).length;
    document.getElementById('presentToday').textContent = (attendanceRows || []).filter(r => (r.Status||r.status) === 'Present').length;
    document.getElementById('pendingLeaves').textContent = (leavesRows || []).filter(r => (r.Status||r.status) === 'Pending').length;

    // attendance table
    const attTbody = document.querySelector('#attendanceTable tbody');
    attTbody.innerHTML = '';
    (attendanceRows || []).slice(0,25).forEach(r => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${r.Name || r.name || r['Emp Name'] || ''}</td><td>${r.Status || r.status || ''}</td><td>${r['Time In'] || r.timeIn || r.CheckINTime || ''}</td><td>${r['Time Out'] || r.timeOut || r.CheckOUTTime || ''}</td>`;
      attTbody.appendChild(tr);
    });

    // leaves table
    const leavesTbody = document.querySelector('#leavesTable tbody');
    leavesTbody.innerHTML = '';
    (leavesRows || []).slice(0,25).forEach(r => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${r.Name || r.name || r['Emp Name'] || r['Employee'] || ''}</td><td>${r.Start || r.startDate || r['Start Date'] || ''}</td><td>${r.End || r.endDate || r['End Date'] || ''}</td><td>${r['Leave Type'] || r.LeaveType || r.type || ''}</td><td>${r.Status || r.status || r['Approval Decision'] || ''}</td>`;
      leavesTbody.appendChild(tr);
    });

    // profile: show columns from employee row
    const profileTbody = document.getElementById('profileTable');
    profileTbody.innerHTML = '';
    const profileFields = ['EmployeeId','Employee ID','Employee Id','Emp ID','Emp Name','Name','Email','DOJ','Date of Joining','Mobile','Designation','title','Title'];
    profileFields.forEach(key => {
      const val = empRow[key] || empRow[key.replace(/\s/g,'')] || empRow[key.toLowerCase()] || empRow[key.toUpperCase()];
      if(val){
        const tr = document.createElement('tr');
        tr.innerHTML = `<th style="width:180px">${key}</th><td>${val}</td>`;
        profileTbody.appendChild(tr);
      }
    });

    // hook apply/mark buttons (open external pages or popup)
    document.getElementById('applyLeave').onclick = () => window.open('https://your-leave-form-url-or-drive-link', '_blank');
    document.getElementById('markAttendance').onclick = () => window.open('https://your-attendance-form-url-or-drive-link', '_blank');

  } catch (err) {
    console.error('Dashboard load error', err);
    diag('Failed to load dashboard data: ' + (err.message || err));
  }
}

/* initialize msal + helpers immediately */
initMsalAndHelpers();
</script>

</body>
</html>
