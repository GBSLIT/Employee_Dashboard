<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Employee Dashboard - Global</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- MSAL (global) -->
  <script src="https://alcdn.msauth.net/browser/2.37.0/js/msal-browser.min.js"></script>

  <style>
    :root{
      --bg:#f6f8fb; --card:#ffffff; --muted:#64748b;
      --accent:#2563eb; --radius:14px;
    }
    html,body,#root{height:100%; margin:0; font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;}
    body{background:linear-gradient(180deg,#f8fbff 0%,var(--bg) 100%); color:#0f172a;}
    .app { display:flex; min-height:100vh; }

    .sidebar {
      width:220px; background:rgba(255,255,255,0.92);
      box-shadow: 8px 0 24px rgba(15,23,42,0.03);
      padding:20px; border-right:1px solid #eef2f7;
      position:sticky; top:0; height:100vh; box-sizing:border-box;
    }

    .logo{
  display:flex;
  align-items:center;
  gap:8px;
  font-weight:700;
  font-size:18px;
  margin-bottom:18px;
}
.nav { margin-top:18px; display:flex; flex-direction:column; gap:6px; }
.nav button {
  text-align:left; background:none; border:none;
  padding:10px 12px; border-radius:10px;
  cursor:pointer; color:#0f172a; font-weight:500;
}
.logo img{
  height:68px;    /* control size here */
  width:auto;
  display:block;
}
    .nav button:hover{ background:#f1f5f9; }
    .nav .active{
      background:linear-gradient(90deg, rgba(37,99,235,0.1), rgba(80,123,255,0.03));
      color:var(--accent);
    }

    .main { flex:1; padding:28px; box-sizing:border-box; }
    .header { display:flex; justify-content:space-between; align-items:center; margin-bottom:18px; }
    .kpi-row { display:flex; gap:12px; flex-wrap:wrap; }
    .kpi {
      background:var(--card); border-radius:12px;
      padding:16px; box-shadow: 0 6px 18px rgba(15,23,42,0.04);
      min-width:170px;
    }
    .kpi .label{ color:var(--muted); font-size:12px; }
    .kpi .value{ font-size:20px; font-weight:700; margin-top:6px; }

    .card {
      background:var(--card); border-radius:12px;
      padding:16px; box-shadow: 0 8px 28px rgba(15,23,42,0.03);
      margin-top:16px;
    }
.quick-actions-card {
  max-width: 420px;     /* controls how wide the box can be */
  width: 100%;
}
.quick-actions-card .btn {
  width: 100%;
  max-width: 340px;     /* button width limit */
  margin: 4px auto;     /* center horizontally */
  display: block;
  border-radius: 12px;
}

    .row { display:flex; gap:16px; align-items:flex-start; }
    .col-2 { display:flex; flex-direction:column; gap:16px; flex:1; }
    table { width:100%; border-collapse:collapse; margin-top:12px; }
    th, td {
      text-align:left; padding:10px 8px;
      border-bottom:1px solid #f1f5f9;
      font-size:14px;
    }

    .muted { color:var(--muted); font-size:13px; }
    .small { font-size:13px; color:var(--muted); }

    .btn {
      background:var(--accent); color:#fff;
      border:none; padding:8px 14px;
      border-radius:10px; cursor:pointer;
      font-weight:600;
    }

    .btn-outline {
      background:#eef2ff;
      color:#1e293b;
      border:none;
      padding:10px 14px;
      border-radius:999px;
      cursor:pointer;
      font-weight:500;
    }

    .search {
      padding:8px 12px; border-radius:10px;
      border:1px solid #eef2f7; width:220px;
    }

    .login-wrap {
      min-height:100vh;
      display:flex; align-items:center; justify-content:center;
    }
    .login-card {
      width:420px; background:var(--card);
      padding:28px; border-radius:16px;
      box-shadow: 0 12px 40px rgba(15,23,42,0.06);
    }

    .summary-card {
      min-width:260px;
    }
    .summary-row {
      display:flex;
      justify-content:space-between;
      padding:6px 0;
      border-bottom:1px solid #f1f5f9;
      font-size:13px;
    }

    footer { margin-top:24px; color:var(--muted); font-size:13px; }

    @media (max-width:1100px){
      .row{flex-direction:column;}
      .summary-card{width:100%;}
    }
    @media (max-width:900px){
      .sidebar{display:none;}
      .main{padding:14px;}
      .kpi{min-width:140px;}
    }

    /* Profile layout */
    .profile-layout{
      display:flex;
      gap:18px;
      align-items:flex-start;
      flex-wrap:wrap;
    }
    .profile-card{
      flex:1;
      min-width:280px;
    }
    .profile-avatar{
      width:140px;
      height:140px;
      border-radius:50%;
      background:#eef2ff;
      overflow:hidden;
      margin-right:24px;
      flex-shrink:0;
    }
    .profile-avatar img{
      width:100%;height:100%;object-fit:cover;
    }
    .profile-grid{
      display:grid;
      grid-template-columns:120px 1fr;
      row-gap:6px;
      column-gap:12px;
      font-size:14px;
    }
    .profile-label{font-weight:600;color:#475569;}
    .qa-buttons{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:8px;
    }
  </style>
</head>

<body>
<div id="root"></div>

<!-- ========= MSAL / GRAPH HELPER (NON-MODULE) ========= -->
<script>
  const CLIENT_ID    = "27917652-ca62-4409-b37c-e47df77bfce9";
  const TENANT_ID    = "93846c24-8666-4033-8b6e-901877a2cf98";
  const REDIRECT_URI = "https://gbslit.github.io/Employee_Dashboard/";
  const DRIVE_ID     = "b!btaPqJ-5kU-kkE4KEoaxo8fltt6l6xpLs60U3YTj_EAxQMgJa8fsSLceYscvhxNo";
  const FILE_ID      = "016GCLEJF6QPT4M3PLEFEITOFBJOBB4R2E";

  const TABLES = {
    employees:    "Employees",
    attendance:   "Attendance",
    leaves:       "Leaves",
    leaveCalc:    "Leave_Calculation",
    weeklyAgenda: "Weekly_Agenda"
  };

  const msalConfig = {
    auth: {
      clientId: CLIENT_ID,
      authority: `https://login.microsoftonline.com/${TENANT_ID}`,
      redirectUri: REDIRECT_URI
    },
    cache: {
      cacheLocation: "localStorage",
      storeAuthStateInCookie: true
    }
  };

  const SCOPES = ["Files.Read.All","User.Read","Sites.Read.All"];

  const msalInstance = new msal.PublicClientApplication(msalConfig);

  async function getToken() {
    let account = msalInstance.getAllAccounts()[0];
    if (!account) {
      const loginResult = await msalInstance.loginPopup({ scopes: SCOPES });
      account = loginResult.account;
    }
    try {
      const tokenResponse = await msalInstance.acquireTokenSilent({
        scopes: SCOPES,
        account
      });
      return tokenResponse.accessToken;
    } catch (e) {
      const tokenResponse = await msalInstance.acquireTokenPopup({ scopes: SCOPES, account });
      return tokenResponse.accessToken;
    }
  }

  // Fetch Excel table and return array of objects
  window.fetchOneDriveTable = async function(tableKeyOrName) {
    const tableName = TABLES[tableKeyOrName] || tableKeyOrName;
    const token = await getToken();
    const base = `https://graph.microsoft.com/v1.0/drives/${DRIVE_ID}/items/${FILE_ID}/workbook`;

    // columns
    const colRes = await fetch(`${base}/tables/${encodeURIComponent(tableName)}/columns`, {
      headers: { Authorization: `Bearer ${token}` }
    });
    if(!colRes.ok) {
      const txt = await colRes.text().catch(()=> '');
      throw new Error("Columns fetch failed: " + colRes.status + " " + txt);
    }
    const colJson = await colRes.json();
    const columns = colJson.value.map(c => c.name);

    // rows
    const rowRes = await fetch(`${base}/tables/${encodeURIComponent(tableName)}/rows`, {
      headers: { Authorization: `Bearer ${token}` }
    });
    if(!rowRes.ok) {
      const txt = await rowRes.text().catch(()=> '');
      throw new Error("Rows fetch failed: " + rowRes.status + " " + txt);
    }
    const rowJson = await rowRes.json();
    const rows = (rowJson.value || []).map(r => {
      const vals = (r.values && r.values[0]) ? r.values[0] : [];
      const obj = {};
      for (let i=0; i<columns.length; i++) obj[columns[i]] = vals[i] ?? null;
      return obj;
    });
    return rows;
  };

  window.msalOneDrive = {
    msalInstance,
    async loginPopup() { return msalInstance.loginPopup({ scopes: SCOPES }); },
    getAccount() { return msalInstance.getAllAccounts()[0] || null; }
  };
</script>

<!-- React UMD -->
<script src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
<!-- Babel -->
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<script type="text/babel">
const { useState } = React;
const APPLY_LEAVE_URL = "https://docs.google.com/forms/d/e/1FAIpQLSf0k4lKKmwB8LWmzPxEb07Q_X-zT8-sSDghHl79wHvtXLSDeA/viewform";
// TEMP LINKS â€“ replace later
const MARK_ATTENDANCE_URL = "https://script.google.com/a/macros/globalbasesourcing.com/s/AKfycbzqqbsaeEpvXupmGG8ew95qckMPPRY3CyhJu1Fwn5jHR6ugAIrow6eSjNSRrAihxxiaCA/exec";
const IT_HELP_TICKET_URL = "https://docs.google.com/forms/d/e/1FAIpQLScDeECNtU4AY66ExE7nP2k_fGoA0iz9jFpSMxvaZDeSsNtP7Q/viewform";
const HIRING_REQUEST_URL = "https://docs.google.com/forms/d/e/1FAIpQLSemLc4jVjHElByCmLZPZM6VvgTvs9blMMUIHi-2dO3lQdWVSw/viewform";
const MONTHLY_FEEDBACK_URL = "https://docs.google.com/forms/d/e/1FAIpQLSfuKxR0xg60CaTSpQDa2XAt9qcdQQMy37Vkryy1mX5N6xdbiA/viewform";
const COMPANY_POLICIES_URL = "https://gbslhk-my.sharepoint.com/:p:/g/personal/hr_globalbasesourcing_com/IQApL-QNk4FES6MunLz973sMAapBWR7Xderr-gtTxvGqCDw?e=GpOs5P";

/* ---------- Excel Date / Time Helpers ---------- */
function excelSerialToDate(value){
  const base = new Date(Date.UTC(1899, 11, 30));
  return new Date(base.getTime() + value * 86400000);
}

function formatExcelDate(value) {
  if (value === null || value === undefined || value === "") return "";
  if (typeof value === "number") {
    const date = excelSerialToDate(value);
    return date.toLocaleDateString("en-GB", {
      day: "2-digit",
      month: "short",
      year: "numeric"
    });
  }
  return String(value);
}

function formatExcelTime(value) {
  if (value === null || value === undefined || value === "") return "";
  if (typeof value === "number") {
    const totalSeconds = Math.round(value * 24 * 60 * 60);
    const hours = Math.floor(totalSeconds / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    return String(hours).padStart(2,"0") + ":" + String(minutes).padStart(2,"0");
  }
  return String(value);
}

function formatExcelDuration(value) {
  if (value === null || value === undefined || value === "") return "";
  if (typeof value === "number") {
    const totalSeconds = Math.round(value * 24 * 60 * 60);
    const hours = Math.floor(totalSeconds / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    const seconds = totalSeconds % 60;
    return (
      String(hours).padStart(2,"0") + ":" +
      String(minutes).padStart(2,"0") + ":" +
      String(seconds).padStart(2,"0")
    );
  }
  return String(value);
}
  function formatDisplayDate(value) {
  if (value === null || value === undefined || value === "") return "â€”";

  let date = null;

  if (typeof value === "number") {
    // Excel serial
    date = excelSerialToDate(value);
  } else {
    const d = new Date(value);
    if (!isNaN(d)) date = d;
  }

  if (!date) return String(value);

  const day = String(date.getDate()).padStart(2, "0");
  const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
  const month = months[date.getMonth()];
  const year = date.getFullYear();

  return `${day}-${month}-${year}`;  // dd-MMM-yyyy
}
/* ------------ Login Card ------------ */
function LoginPage({ onSignIn, error }) {
  return (
    <div className="login-wrap">
      <div className="login-card">
        <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:12}}>
          <div style={{fontSize:20,fontWeight:700}}>Employee Dashboard</div>
          <div style={{color:'var(--muted)',fontSize:13}}>Sign in with Microsoft 365</div>
        </div>

        <h2 style={{marginTop:6}}>Sign in</h2>
        <p className="small">
          Global Base â€” Employee Dashboard
        </p>

        {error && (
          <div style={{color:'#dc2626',fontSize:13,marginTop:10}}>
            {error}
          </div>
        )}

        <div style={{marginTop:18}}>
          <button type="button" className="btn" onClick={onSignIn} style={{width:'100%'}}>
            Sign in with Microsoft 365
          </button>
        </div>

        <footer style={{marginTop:16}} className="small muted">
          Your email is only used to Login in Employees Dashboard.
        </footer>
      </div>
    </div>
  );
}

/* ------------ Sidebar ------------ */
function Sidebar({ current, onSelect, onLogout, user }) {
  const tabs = ['Weekly Agenda','Attendance','Leaves','Profile'];
  return (
    <div className="sidebar">
      <div>
  <div className="logo">
    <img
      src="gbsl.png"  // ðŸ” put your logo URL or relative path
      alt="Global Base"
      className="logo-img"
    />
    <span></span>
  </div>
  <div className="muted">Employee Dashboard</div>
</div>
      <div className="nav">
        {tabs.map(t=>(
          <button
            key={t}
            className={current===t ? 'active' : ''}
            onClick={()=>onSelect(t)}
          >
            {t}
          </button>
        ))}
      </div>
      <div style={{marginTop:'auto', marginBottom:8}} className="small muted">
        Signed in as <strong>{user?.name || user?.email || 'Employee'}</strong><br/>
        <span>{user?.email}</span>
      </div>
      <button onClick={onLogout} className="btn" style={{width:'100%'}}>Sign out</button>
    </div>
  );
}

function KPICard({label, value}) {
  return (
    <div className="kpi">
      <div className="label">{label}</div>
      <div className="value">{value}</div>
    </div>
  );
}

/* ------------ Attendance Page ------------ */
function AttendancePage({ attendance, leaves }) {
  const now = new Date();
  const currentMonth = now.getMonth();
  const currentYear = now.getFullYear();
  const lastMonthDate = new Date(currentYear, currentMonth - 1, 1);
  const lastMonth = lastMonthDate.getMonth();
  const lastMonthYear = lastMonthDate.getFullYear();

  const currentMonthAttendance = attendance.filter(
    a => a.month === currentMonth && a.year === currentYear
  );
  const lastMonthAttendance = attendance.filter(
    a => a.month === lastMonth && a.year === lastMonthYear
  );

  const currentMonthLeaves = leaves.filter(
    l => l.month === currentMonth && l.year === currentYear
  );

  const currentAppliedCount = currentMonthLeaves.length;
  const currentApprovedCount = currentMonthLeaves.filter(
    l => (l.status || '').toLowerCase().includes('approved')
  ).length;

  const totalAppliedDays = leaves.reduce(
    (sum,l)=>sum + (Number(l.appliedDays) || 0),
    0
  );
  const totalApprovedDays = leaves.reduce(
    (sum,l)=>sum + (Number(l.approvedDays) || 0),
    0
  );

  const monthNames = ["January","February","March","April","May","June","July",
    "August","September","October","November","December"];

  function renderAttendanceTable(title, subtitle, rows) {
    return (
      <div className="card">
        <strong>{title}</strong>
        <p className="muted">{subtitle}</p>
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Day</th>
              <th>Check In Time</th>
              <th>Check Out Time</th>
              <th>Late Hours</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            {rows.map((r,i)=>(
              <tr key={i}>
                <td>{r.date}</td>
                <td>{r.day}</td>
                <td>{r.timeIn}</td>
                <td>{r.timeOut}</td>
                <td
  style={{
    color:
      r.lateHours === "On Time"
        ? "#16a34a"   // green
        : r.lateHours
        ? "#dc2626"   // red
        : "inherit"
  }}
>
  {r.lateHours}
</td>

                <td>{r.status}</td>
              </tr>
            ))}
            {rows.length === 0 && (
              <tr>
                <td colSpan="6" className="muted">No records.</td>
              </tr>
            )}
          </tbody>
        </table>
      </div>
    );
  }

  return (
    <div>
      <div className="kpi-row">
        <KPICard label="My Attendance Records" value={currentMonthAttendance.length} />
        <KPICard label="Applied Leaves" value={totalAppliedDays} />
        <KPICard label="Approved Leaves" value={totalApprovedDays} />
      </div>

      <div className="row" style={{marginTop:12}}>
        <div className="col-2">
          {renderAttendanceTable(
            `${monthNames[currentMonth]} ${currentYear} Attendance`,
            "This month attendance records",
            currentMonthAttendance
          )}
          {renderAttendanceTable(
            `${monthNames[lastMonth]} ${lastMonthYear} Attendance`,
            "Last month attendance records",
            lastMonthAttendance
          )}
        </div>

        <div className="card summary-card">
          <strong>Summary</strong>
          <p className="muted">Quick view</p>
          <div className="summary-row">
            <span>Current month days</span>
            <span>{currentMonthAttendance.length}</span>
          </div>
          <div className="summary-row">
            <span>Last month days</span>
            <span>{lastMonthAttendance.length}</span>
          </div>
          <div className="summary-row">
            <span>Current applied leaves</span>
            <span>{currentAppliedCount}</span>
          </div>
          <div className="summary-row">
            <span>Current approved leaves</span>
            <span>{currentApprovedCount}</span>
          </div>
        </div>
      </div>
    </div>
  );
}

/* ------------ Leaves Page ------------ */
function LeavesPage({ leaves, leaveSummary }) {
  const {
    allottedCL, allottedSL,
    usedCL, usedSL,
    availableCL, availableSL
  } = leaveSummary || {};

  return (
    <div>
      <div className="card">
        <strong>Paid Leave Calculation</strong>
        <table>
          <thead>
            <tr>
              <th>Leave</th>
              <th>Casual Leave (CL)</th>
              <th>Sick Leave (SL)</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Allotted Leave</td>
              <td>{allottedCL ?? 0}</td>
              <td>{allottedSL ?? 0}</td>
            </tr>
            <tr>
              <td>Used Leave</td>
              <td>{usedCL ?? 0}</td>
              <td>{usedSL ?? 0}</td>
            </tr>
            <tr>
              <td>Available Leave</td>
              <td>{availableCL ?? 0}</td>
              <td>{availableSL ?? 0}</td>
            </tr>
          </tbody>
        </table>
        <div style={{marginTop:8, color:'#b91c1c', fontSize:13}}>
          Note:- Each month, 0.5 days of Sick Leave and 0.5 days of Casual Leave are credited to your account.
          Advance leave is not provided. You can save your leave days to take them together.
        </div>
      </div>

      <div className="card">
        <div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}>
          <strong>My Leaves</strong>
          <button
  className="btn"
  onClick={() => window.open(APPLY_LEAVE_URL, "_blank")}
>
  Apply Leave
</button>
        </div>
        <table>
          <thead>
            <tr>
              <th>From</th>
              <th>To</th>
              <th>Applied Number of working days</th>
              <th>Status</th>
              <th>Approved Number of days</th>
            </tr>
          </thead>
          <tbody>
            {leaves.map((l,i)=>(
              <tr key={i}>
                <td>{l.start}</td>
                <td>{l.end}</td>
                <td>{l.appliedDays}</td>
                <td>{l.status}</td>
                <td>{l.approvedDays}</td>
              </tr>
            ))}
            {leaves.length === 0 && (
              <tr>
                <td colSpan="5" className="muted">No leave records.</td>
              </tr>
            )}
          </tbody>
        </table>
      </div>
    </div>
  );
}

/* ------------ Weekly Agenda Page ------------ */
function WeeklyAgendaPage({ items }) {
  return (
    <div>
      <div className="card">
        <div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}>
          <strong>Weekly Agenda</strong>
        </div>
        <table>
          <thead>
            <tr>
              <th>Task No</th>
              <th>Task Details</th>
              <th>Assigner Email Id</th>
              <th>Assignee Email Id</th>
              <th>Initial Target Date</th>
              <th>Submission Type</th>
              <th>Completion Status %</th>
              <th>Update Remarks</th>
              <th>Completion Date</th>
              <th>Update Link</th>
            </tr>
          </thead>
          <tbody>
            {items.map((r,i)=>(
              <tr key={i}>
                <td>{r.taskNo}</td>
                <td>{r.taskDetails}</td>
                <td>{r.assignerEmail}</td>
                <td>{r.assigneeEmail}</td>
                <td>{r.initialTarget}</td>
                <td>{r.submissionType}</td>
                <td>{r.completionPercent}</td>
                <td>{r.updateRemarks}</td>
                <td>{r.completionDate}</td>
                <td>
                  {r.updateLink ? (
                    <a href={r.updateLink} target="_blank" rel="noopener noreferrer">Open</a>
                  ) : "â€”"}
                </td>
              </tr>
            ))}
            {items.length === 0 && (
              <tr>
                <td colSpan="18" className="muted">No tasks assigned.</td>
              </tr>
            )}
          </tbody>
        </table>
      </div>
    </div>
  );
}

/* ------------ Profile Page ------------ */
function ProfilePage({ employee }) {
  if(!employee) {
    return (
      <div className="card">
        Employee not found in Excel. Check Employees table for your email.
      </div>
    );
  }

  const initials = employee.name
    ? employee.name.split(' ').map(n=>n[0]).slice(0,2).join('')
    : '';

  return (
    <div className="profile-layout">
      <div className="card profile-card quick-actions-card">
        <div style={{display:'flex',alignItems:'center',marginBottom:16}}>
          <div className="profile-avatar">
            {employee.photoUrl ? (
              <img src={employee.photoUrl} alt={employee.name} />
            ) : (
              <div style={{
                width:'100%',height:'100%',display:'flex',
                alignItems:'center',justifyContent:'center',
                fontSize:36,fontWeight:700,color:'var(--accent)'
              }}>
                {initials}
              </div>
            )}
          </div>
          <div>
            <div style={{fontSize:20,fontWeight:700}}>{employee.name}</div>
            <div className="muted">{employee.designation || 'Employee'} &bull; {employee.department || 'â€”'}</div>
            <div className="small" style={{marginTop:4}}>Emp ID: {employee.id}</div>
            {employee.awards && (
              <div className="small">Awards: {employee.awards}</div>
            )}
          </div>
        </div>

        <div className="profile-grid">
          <div className="profile-label">DOJ</div>
          <div>{formatDisplayDate(employee.doj)}</div>

          <div className="profile-label">Email Address</div>
          <div>{employee.email}</div>

          <div className="profile-label">Contact</div>
          <div>{employee.mobile || "â€”"}</div>

          <div className="profile-label">Department</div>
          <div>{employee.department || "â€”"}</div>

          <div className="profile-label">Designation</div>
          <div>{employee.designation || "â€”"}</div>

          <div className="profile-label">Skills & Expertise</div>
          <div>{employee.skills || "â€”"}</div>

          <div className="profile-label">Country</div>
          <div>{employee.country || "â€”"}</div>

          <div className="profile-label">Birth date</div>
          <div>{formatDisplayDate(employee.birthDate)}</div>
        </div>
      </div>

      <div className="card profile-card">
        <strong>Quick Actions</strong>
        <div className="qa-buttons">
  <button
    className="btn"
    onClick={() => window.open(MARK_ATTENDANCE_URL, "_blank")}
  >
    Mark Attendance
  </button>

  <button
    className="btn"
    onClick={() => window.open(APPLY_LEAVE_URL, "_blank")}
  >
    Apply Leave
  </button>

  <button
    className="btn"
    onClick={() => window.open(IT_HELP_TICKET_URL, "_blank")}
  >
    IT Help Ticket
  </button>

  <button
    className="btn"
    onClick={() => window.open(HIRING_REQUEST_URL, "_blank")}
  >
    Raise Hiring Request
  </button>

  <button
    className="btn"
    onClick={() => window.open(MONTHLY_FEEDBACK_URL, "_blank")}
  >
    GBSL Monthly Feedback
  </button>

  <button
    className="btn"
    onClick={() => window.open(COMPANY_POLICIES_URL, "_blank")}
  >
    Company Policies
  </button>
</div>

      </div>
    </div>
  );
}

/* ------------ App ------------ */
function App() {
  const [user, setUser] = useState(null);          // { email, name }
  const [activeTab, setActiveTab] = useState('Weekly Agenda');
  const [employees, setEmployees] = useState([]);
  const [attendance, setAttendance] = useState([]);
  const [leaves, setLeaves] = useState([]);
  const [weeklyAgenda, setWeeklyAgenda] = useState([]);
  const [leaveSummary, setLeaveSummary] = useState({
    allottedCL:0, allottedSL:0,
    usedCL:0, usedSL:0,
    availableCL:0, availableSL:0
  });
  const [currentEmployee, setCurrentEmployee] = useState(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');

  function normalize(str) {
    return (str || '').toString().trim().toLowerCase();
  }

  async function handleMsSignIn() {
    try {
      setError('');
      await window.msalOneDrive.loginPopup();
      const account = window.msalOneDrive.getAccount();
      if (!account) {
        setError('Unable to get Microsoft account after login.');
        return;
      }
      const email =
        (account.username ||
         account.email ||
         (account.idTokenClaims && account.idTokenClaims.preferred_username) ||
         '').toLowerCase();

      const name = account.name || email;
      setUser({ email, name });
      setActiveTab('Weekly Agenda');

      await loadLiveDataFor(email);
    } catch (e) {
      console.error(e);
      setError('Microsoft sign-in failed. See console for details.');
    }
  }

  async function loadLiveDataFor(userEmail) {
    try {
      setLoading(true);
      setError("");

      const lowerEmail = normalize(userEmail);
      let me = null;

      /* ===== 1) EMPLOYEES TABLE ===== */
      const empRows = await window.fetchOneDriveTable("employees").catch(() => null);

      if (empRows && empRows.length) {
        const mappedEmps = empRows.map((r) => {
          const id =
            r["Employee ID"] ||
            r.EmployeeID ||
            r.employeeId ||
            r["Employee Id"] ||
            r["Emp ID"] ||
            null;

          const primaryEmail =
            r["Microsoft Email ID"] ||
            r["Microsoft Email"] ||
            r.MicrosoftEmailID ||
            null;

          const altEmail =
            r["Email address"] ||
            r["Email Address"] ||
            r.Email ||
            r.email ||
            null;

          return {
            id,
            name: r["Emp Name"] || r.EmpName || r.Name || "",
            email: (primaryEmail || altEmail || "").toString().trim(),
            primaryEmail: (primaryEmail || "").toString().trim(),
            altEmail: (altEmail || "").toString().trim(),
            department: r["Department"] || "",
            designation: r["Designation"] || "",
            skills: r["Skills & Expertise"] || "",
            country: r["Country"] || "",
            birthDate: r["Birth date"] || "",
            awards: r["Awards"] || "",
            photoUrl:
              r["Employee Photo"] ||
              r["EmployeePhoto"] ||
              r["Photo URL"] ||
              r.PhotoUrl ||
              null,
            doj: r.DOJ || r["DOJ"] || "",
            mobile: r.Mobile || r["Mobile"] || null
          };
        });

        me =
          mappedEmps.find(e => normalize(e.primaryEmail) === lowerEmail) ||
          mappedEmps.find(e => normalize(e.altEmail) === lowerEmail) ||
          null;

        setEmployees(mappedEmps);
        if (me) {
          me = { ...me, email: me.email || me.primaryEmail || me.altEmail };
          setCurrentEmployee(me);
        } else {
          console.warn(
            "No employee row matching email:",
            lowerEmail,
            "Check Employees table 'Microsoft Email ID' / 'Email address' columns."
          );
        }
      }

      const myId = me && me.id ? normalize(me.id) : null;
      const myName = me && me.name ? normalize(me.name) : null;

      /* ===== 2) ATTENDANCE TABLE ===== */
      const attRows = await window.fetchOneDriveTable("attendance").catch(() => null);
      if (attRows && attRows.length) {
        let mapped = attRows.map((r) => {
          const rawDate =
            r["Date"] ||
            r.Date ||
            "";

          let jsDate = null;
          if (typeof rawDate === "number") {
            jsDate = excelSerialToDate(rawDate);
          } else if (rawDate) {
            jsDate = new Date(rawDate);
          }

          const rawTimeIn =
            r["Time_In"] ||
            r["Check-IN Time"] ||
            r["Check In Time"] ||
            r.CheckINTime ||
            "";

          const rawTimeOut =
            r["Time_Out"] ||
            r["Check-Out Time"] ||
            r["Check Out Time"] ||
            r.CheckOutTime ||
            "";

          const rawLate =
            r["Late Hours"] ||
            r["Late Hour"] ||
            r.LateHours ||
            "";

          const jsDay = jsDate ? jsDate.toLocaleDateString("en-GB", { weekday:"short" }) : "";

          return {
            employeeEmail:
              r["Email ID"] ||
              r["Email"] ||
              r.EmailID ||
              r.Email ||
              "",
            name: r["Emp Name"] || r.EmpName || "",
            date: formatExcelDate(rawDate),
            day: jsDay,
            status: r["Status"] || r.Status || "",
            timeIn: formatExcelTime(rawTimeIn),
            timeOut: formatExcelTime(rawTimeOut),
            lateHours: formatExcelDuration(rawLate),
            month: jsDate ? jsDate.getMonth() : null,
            year: jsDate ? jsDate.getFullYear() : null
          };
        });

        if (lowerEmail) {
          mapped = mapped.filter(
            (a) => normalize(a.employeeEmail) === lowerEmail
          );
        }

        setAttendance(mapped);
      }

      /* ===== 3) LEAVES TABLE ===== */
      const leavesRows = await window.fetchOneDriveTable("leaves").catch(() => null);
      if (leavesRows && leavesRows.length) {
        let mapped = leavesRows.map((r) => {
          const rawStart =
            r["Start Date"] ||
            r.StartDate ||
            r.Start ||
            "";

          let jsStart = null;
          if (typeof rawStart === "number") {
            jsStart = excelSerialToDate(rawStart);
          } else if (rawStart) {
            jsStart = new Date(rawStart);
          }

          const appliedDays =
            Number(
              r["Applied Number of working days"] ||
              r["Applied Number of days"] ||
              r.AppliedDays ||
              0
            );

          const approvedDays =
            Number(
              r["Approved Number of days"] ||
              r["Approved Days"] ||
              r["Paid Days"] ||
              r.PaidDays ||
              0
            );

          return {
            employeeId:
              r["Employee Id"] ||
              r["Employee ID"] ||
              r.EmployeeId ||
              r.EmployeeID ||
              null,
            name: r["Name"] || r.Name || "",
            start: formatExcelDate(rawStart),
            end: formatExcelDate(
              r["End Date"] || r.EndDate || r.End || ""
            ),
            type: r["Leave Type"] || r.LeaveType || "",
            status: r["Approval Decision"] || r.ApprovalDecision || "",
            appliedDays,
            approvedDays,
            month: jsStart ? jsStart.getMonth() : null,
            year: jsStart ? jsStart.getFullYear() : null
          };
        });

        if (myId) {
          mapped = mapped.filter(
            (l) => normalize(l.employeeId) === myId
          );
        }

        setLeaves(mapped);
      }

      /* ===== 4) LEAVE CALCULATION TABLE ===== */
      const calcRows = await window.fetchOneDriveTable("leaveCalc").catch(()=>null);
      if (calcRows && calcRows.length) {
        let row = null;
        if (myId) {
          row = calcRows.find(r =>
            normalize(
              r["Employee Id"] ||
              r["Employee ID"] ||
              r["Emp ID"] ||
              r.EmployeeId ||
              ""
            ) === myId
          );
        }
        if (!row && myName) {
          row = calcRows.find(r => normalize(r["Name"] || r.Name || "") === myName);
        }

        if (row) {
          const totalLeaves = Number(row["Total Leaves"] || row.TotalLeaves || 0);
          const half = totalLeaves / 2;
          const usedCL = Number(row["Casual Leave (CL)"] || row["Casual Leave"] || 0);
          const usedSL = Number(row["Sick Leave (SL)"] || row["Sick Leave"] || 0);

          setLeaveSummary({
            allottedCL: half,
            allottedSL: half,
            usedCL,
            usedSL,
            availableCL: half - usedCL,
            availableSL: half - usedSL
          });
        }
      }

      /* ===== 5) WEEKLY AGENDA TABLE ===== */
      const agendaRows = await window.fetchOneDriveTable("weeklyAgenda").catch(()=>null);
      if (agendaRows && agendaRows.length) {
        let mapped = agendaRows.map(r => ({
          taskNo: r["Task No"] || r.TaskNo || "",
          taskDetails: r["Task Details"] || r.TaskDetails || "",
          assignerEmail: r["Assigner Email Id"] || r.AssignerEmailId || "",
          assigneeEmail: r["Assignee Email Id"] || r.AssigneeEmailId || "",
          initialTarget: formatExcelDate(r["Initial Target Date"] || r.InitialTargetDate || ""),
          submissionType: r["Submission Type"] || r.SubmissionType || "",
          completionPercent: r["Completion Status %"] || r.CompletionStatus || "",
          updateRemarks: r["Update Remarks"] || r.UpdateRemarks || "",
          completionDate: formatExcelDate(r["Completion Date"] || r.CompletionDate || ""),
          updateLink: r["Update Link"] || r.UpdateLink || ""
        }));

        if (lowerEmail) {
          mapped = mapped.filter(r => normalize(r.assigneeEmail) === lowerEmail);
        }

        setWeeklyAgenda(mapped);
      }

    } catch (err) {
      console.error("Live data load failed", err);
      setError("Error loading data from Excel. Check console for details.");
    } finally {
      setLoading(false);
    }
  }

  function handleLogout() {
    setUser(null);
    setCurrentEmployee(null);
    setEmployees([]);
    setAttendance([]);
    setLeaves([]);
    setWeeklyAgenda([]);
    setActiveTab('Attendance');
  }

  if (!user) {
    return <LoginPage onSignIn={handleMsSignIn} error={error} />;
  }

  const employee = currentEmployee || (employees.length ? employees[0] : null);

  return (
    <div className="app">
      <Sidebar current={activeTab} onSelect={setActiveTab} onLogout={handleLogout} user={user} />
      <div className="main">
        <div className="header">
          <div>
            <div style={{fontSize:22,fontWeight:700}}>Global Base â€” Employee Dashboard</div>
            <div className="muted">Data for <strong>{user.email}</strong></div>
          </div>
          <div style={{display:'flex', gap:12, alignItems:'center'}}>
            {loading && <div className="small muted">Refreshing dataâ€¦</div>}
          </div>
        </div>

        {activeTab === 'Attendance' && (
          <AttendancePage attendance={attendance} leaves={leaves} />
        )}
        {activeTab === 'Leaves' && (
          <LeavesPage leaves={leaves} leaveSummary={leaveSummary} />
        )}
        {activeTab === 'Weekly Agenda' && (
          <WeeklyAgendaPage items={weeklyAgenda} />
        )}
        {activeTab === 'Profile' && (
          <ProfilePage employee={employee} />
        )}

        <footer>
          <div className="muted">
            Global Base â€” Employee Dashboard Created by GBSL IT.
          </div>
        </footer>
      </div>
    </div>
  );
}

/* Render */
ReactDOM.createRoot(document.getElementById("root")).render(<App />);
</script>

</body>
</html>






















