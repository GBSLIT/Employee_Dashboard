<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Employee Dashboard - Global</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- MSAL (global) -->
  <script src="https://alcdn.msauth.net/browser/2.37.0/js/msal-browser.min.js"></script>

  <style>
    :root{
      --bg:#f6f8fb; --card:#ffffff; --muted:#64748b;
      --accent:#2563eb; --radius:14px;
    }
    html,body,#root{height:100%; margin:0; font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;}
    body{background:linear-gradient(180deg,#f8fbff 0%,var(--bg) 100%); color:#0f172a;}
    .app { display:flex; min-height:100vh; }

    .sidebar {
      width:220px; background:rgba(255,255,255,0.92);
      box-shadow: 8px 0 24px rgba(15,23,42,0.03);
      padding:20px; border-right:1px solid #eef2f7;
      position:sticky; top:0; height:100vh; box-sizing:border-box;
    }

    .logo { font-weight:700; font-size:18px; margin-bottom:18px; }
    .nav { margin-top:18px; display:flex; flex-direction:column; gap:6px; }
    .nav button {
      text-align:left; background:none; border:none;
      padding:10px 12px; border-radius:10px;
      cursor:pointer; color:#0f172a; font-weight:500;
    }
    .nav button:hover{ background:#f1f5f9; }
    .nav .active{
      background:linear-gradient(90deg, rgba(37,99,235,0.1), rgba(80,123,255,0.03));
      color:var(--accent);
    }

    .main { flex:1; padding:28px; box-sizing:border-box; }
    .header { display:flex; justify-content:space-between; align-items:center; margin-bottom:18px; }
    .kpi-row { display:flex; gap:12px; flex-wrap:wrap; }
    .kpi {
      background:var(--card); border-radius:12px;
      padding:16px; box-shadow: 0 6px 18px rgba(15,23,42,0.04);
      min-width:170px;
    }
    .kpi .label{ color:var(--muted); font-size:12px; }
    .kpi .value{ font-size:20px; font-weight:700; margin-top:6px; }

    .card {
      background:var(--card); border-radius:12px;
      padding:16px; box-shadow: 0 8px 28px rgba(15,23,42,0.03);
      margin-top:16px;
    }

    .row { display:flex; gap:12px; }
    .col-2 { display:flex; flex-direction:column; gap:12px; flex:1; }
    table { width:100%; border-collapse:collapse; margin-top:12px; }
    th, td {
      text-align:left; padding:10px 8px;
      border-bottom:1px solid #f1f5f9;
      font-size:14px;
    }

    .muted { color:var(--muted); font-size:13px; }
    .small { font-size:13px; color:var(--muted); }

    .btn {
      background:var(--accent); color:#fff;
      border:none; padding:8px 12px;
      border-radius:10px; cursor:pointer;
    }

    .search {
      padding:8px 12px; border-radius:10px;
      border:1px solid #eef2f7; width:220px;
    }

    .login-wrap {
      min-height:100vh;
      display:flex; align-items:center; justify-content:center;
    }
    .login-card {
      width:420px; background:var(--card);
      padding:28px; border-radius:16px;
      box-shadow: 0 12px 40px rgba(15,23,42,0.06);
    }

    .tabbar { display:flex; gap:8px; margin-top:12px; }
    .tab {
      padding:8px 12px; border-radius:10px;
      background:#f8fafc; cursor:pointer;
      font-weight:600;
    }
    .tab.active {
      background:linear-gradient(90deg,#eef2ff,#fff);
      color:var(--accent);
      box-shadow:0 6px 18px rgba(37,99,235,0.06);
    }

    .link-btn { background:none; border:none; color:var(--accent); cursor:pointer; padding:0; font-weight:600; }
    footer { margin-top:24px; color:var(--muted); font-size:13px; }

    /* Paid Leave Calculation */
    .paid-leave-title {
      text-align:center;
      font-weight:700;
      margin-bottom:4px;
    }
    .paid-leave-note {
      margin-top:8px;
      font-size:13px;
      color:#b91c1c;
    }

    @media (max-width:900px){
      .sidebar{display:none;}
      .main{padding:14px;}
      .row{flex-direction:column;}
      .kpi{min-width:140px;}
    }
  </style>
</head>

<body>
<div id="root"></div>

<!-- ========= MSAL / GRAPH HELPER (NON-MODULE) ========= -->
<script>
  const CLIENT_ID    = "27917652-ca62-4409-b37c-e47df77bfce9";
  const TENANT_ID    = "93846c24-8666-4033-8b6e-901877a2cf98";
  const REDIRECT_URI = "https://gbslit.github.io/Employee_Dashboard/";
  const DRIVE_ID     = "b!btaPqJ-5kU-kkE4KEoaxo8fltt6l6xpLs60U3YTj_EAxQMgJa8fsSLceYscvhxNo";
  const FILE_ID      = "016GCLEJF6QPT4M3PLEFEITOFBJOBB4R2E";

  const TABLES = {
    employees:  "Employees",
    attendance: "Attendance",
    leaves:     "Leaves",
    weeklyAgenda: "Weekly_Agenda",   // NEW
    htm:        "HTM_LeaveCodes"
  };

  const msalConfig = {
    auth: {
      clientId: CLIENT_ID,
      authority: `https://login.microsoftonline.com/${TENANT_ID}`,
      redirectUri: REDIRECT_URI
    },
    cache: {
      cacheLocation: "localStorage",
      storeAuthStateInCookie: true
    }
  };

  const SCOPES = ["Files.Read.All","User.Read","Sites.Read.All"];

  const msalInstance = new msal.PublicClientApplication(msalConfig);

  async function getToken() {
    let account = msalInstance.getAllAccounts()[0];
    if (!account) {
      const loginResult = await msalInstance.loginPopup({ scopes: SCOPES });
      account = loginResult.account;
    }
    try {
      const tokenResponse = await msalInstance.acquireTokenSilent({
        scopes: SCOPES,
        account
      });
      return tokenResponse.accessToken;
    } catch (e) {
      const tokenResponse = await msalInstance.acquireTokenPopup({ scopes: SCOPES, account });
      return tokenResponse.accessToken;
    }
  }

  // Fetch Excel table and return array of objects
  window.fetchOneDriveTable = async function(tableKeyOrName) {
    const tableName = TABLES[tableKeyOrName] || tableKeyOrName;
    const token = await getToken();
    const base = `https://graph.microsoft.com/v1.0/drives/${DRIVE_ID}/items/${FILE_ID}/workbook`;

    // columns
    const colRes = await fetch(`${base}/tables/${encodeURIComponent(tableName)}/columns`, {
      headers: { Authorization: `Bearer ${token}` }
    });
    if(!colRes.ok) {
      const txt = await colRes.text().catch(()=> '');
      throw new Error("Columns fetch failed: " + colRes.status + " " + txt);
    }
    const colJson = await colRes.json();
    const columns = colJson.value.map(c => c.name);

    // rows
    const rowRes = await fetch(`${base}/tables/${encodeURIComponent(tableName)}/rows`, {
      headers: { Authorization: `Bearer ${token}` }
    });
    if(!rowRes.ok) {
      const txt = await rowRes.text().catch(()=> '');
      throw new Error("Rows fetch failed: " + rowRes.status + " " + txt);
    }
    const rowJson = await rowRes.json();
    const rows = (rowJson.value || []).map(r => {
      const vals = (r.values && r.values[0]) ? r.values[0] : [];
      const obj = {};
      for (let i=0; i<columns.length; i++) obj[columns[i]] = vals[i] ?? null;
      return obj;
    });
    return rows;
  };

  window.msalOneDrive = {
    msalInstance,
    async loginPopup() { return msalInstance.loginPopup({ scopes: SCOPES }); },
    getAccount() { return msalInstance.getAllAccounts()[0] || null; }
  };
</script>

<!-- React UMD -->
<script src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
<!-- Babel -->
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<script type="text/babel">
const { useState } = React;

/* ---------- Excel Date / Time Helpers ---------- */
function excelToJSDate(value) {
  if (value === null || value === undefined || value === "") return null;
  if (typeof value === "number") {
    const base = new Date(Date.UTC(1899, 11, 30));
    return new Date(base.getTime() + value * 86400000);
  }
  const d = new Date(value);
  return isNaN(d.getTime()) ? null : d;
}

function formatExcelDate(value) {
  const date = excelToJSDate(value);
  if (!date) return "";
  return date.toLocaleDateString("en-GB", {
    day: "2-digit",
    month: "short",
    year: "numeric"
  });
}

function formatExcelTime(value) {
  if (value === null || value === undefined || value === "") return "";
  if (typeof value === "number") {
    const totalSeconds = Math.round(value * 24 * 60 * 60);
    const hours = Math.floor(totalSeconds / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    return String(hours).padStart(2,"0") + ":" + String(minutes).padStart(2,"0");
  }
  return String(value);
}

/* ------------ Login Card ------------ */
function LoginPage({ onSignIn, error }) {
  return (
    <div className="login-wrap">
      <div className="login-card">
        <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:12}}>
          <div style={{fontSize:20,fontWeight:700}}>Employee Dashboard</div>
          <div style={{color:'var(--muted)',fontSize:13}}>Sign in with Microsoft 365</div>
        </div>

        <h2 style={{marginTop:6}}>Sign in</h2>
        <p className="small">
          Use your company email (Microsoft 365 account). Data will be filtered to your records only.
        </p>

        {error && (
          <div style={{color:'#dc2626',fontSize:13,marginTop:10}}>
            {error}
          </div>
        )}

        <div style={{marginTop:18}}>
          <button type="button" className="btn" onClick={onSignIn} style={{width:'100%'}}>
            Sign in with Microsoft 365
          </button>
        </div>

        <footer style={{marginTop:16}} className="small muted">
          Your email is only used to match your row in the Employees Excel table.
        </footer>
      </div>
    </div>
  );
}

/* ------------ Sidebar ------------ */
function Sidebar({ current, onSelect, onLogout, user }) {
  const tabs = ['Overview','Leaves','Weekly Agenda','Profile'];
  return (
    <div className="sidebar">
      <div className="logo">Acme Corp</div>
      <div className="muted">Employee Dashboard</div>
      <div className="nav">
        {tabs.map(t=>{
          const label = t === 'Overview' ? 'Attendance' : t;
          return (
            <button
              key={t}
              className={current===t ? 'active' : ''}
              onClick={()=>onSelect(t)}
            >
              {label}
            </button>
          );
        })}
      </div>
      <div style={{marginTop:'auto', marginBottom:8}} className="small muted">
        Signed in as <strong>{user?.name || user?.email || 'Employee'}</strong><br/>
        <span>{user?.email}</span>
      </div>
      <button onClick={onLogout} className="btn" style={{width:'100%'}}>Sign out</button>
    </div>
  );
}

function KPICard({label, value}) {
  return (
    <div className="kpi">
      <div className="label">{label}</div>
      <div className="value">{value}</div>
    </div>
  );
}

/* ------------ Attendance (Overview) ------------ */
function Overview({attendance, leaves}) {
  const now = new Date();
  const currentMonth = now.getMonth();
  const currentYear = now.getFullYear();
  const prevMonthDate = new Date(currentYear, currentMonth - 1, 1);
  const prevMonth = prevMonthDate.getMonth();
  const prevYear = prevMonthDate.getFullYear();

  const monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];
  const currentLabel = `${monthNames[currentMonth]} Attendance`;
  const prevLabel = `${monthNames[prevMonth]} Attendance`;

  const currentMonthRows = attendance.filter(r =>
    r.dateObj &&
    r.dateObj.getMonth() === currentMonth &&
    r.dateObj.getFullYear() === currentYear
  );

  const prevMonthRows = attendance.filter(r =>
    r.dateObj &&
    r.dateObj.getMonth() === prevMonth &&
    r.dateObj.getFullYear() === prevYear
  );

  const appliedLeavesCount = leaves.length;
  const approvedLeavesCount = leaves.filter(
    l => (l.status || '').toLowerCase() === 'approved'
  ).length;

  return (
    <div>
      <div className="kpi-row">
        <KPICard label="My Attendance Records" value={attendance.length} />
        <KPICard label="Applied Leaves" value={appliedLeavesCount} />
        <KPICard label="Approved Leaves" value={approvedLeavesCount} />
      </div>

      <div className="row" style={{marginTop:12}}>
        <div className="col-2">
          <div className="card">
            <strong>{currentLabel}</strong>
            <p className="muted">This month attendance records</p>
            <table>
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Day</th>
                  <th>Check In Time</th>
                  <th>Check Out Time</th>
                  <th>Late Hours</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                {currentMonthRows.map((r,i)=>(
                  <tr key={i}>
                    <td>{r.date}</td>
                    <td>{r.day}</td>
                    <td>{r.timeIn}</td>
                    <td>{r.timeOut}</td>
                    <td>{r.lateHours}</td>
                    <td>{r.status}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>

          <div className="card">
            <strong>{prevLabel}</strong>
            <p className="muted">Last month attendance records</p>
            <table>
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Day</th>
                  <th>Check In Time</th>
                  <th>Check Out Time</th>
                  <th>Late Hours</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                {prevMonthRows.map((r,i)=>(
                  <tr key={i}>
                    <td>{r.date}</td>
                    <td>{r.day}</td>
                    <td>{r.timeIn}</td>
                    <td>{r.timeOut}</td>
                    <td>{r.lateHours}</td>
                    <td>{r.status}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  );
}

/* ------------ Leaves Tab (with Paid Leave Calculation) ------------ */
function LeavesTab({leaves, leaveCalc}) {
  const {
    allottedCL = 0,
    allottedSL = 0,
    usedCL = 0,
    usedSL = 0,
    availCL = 0,
    availSL = 0
  } = leaveCalc || {};

  return (
    <div>
      {/* Paid Leave Calculation */}
      <div className="card">
        <div className="paid-leave-title">Paid Leave Calculation</div>
        <table>
          <thead>
            <tr>
              <th>Leave</th>
              <th>Casual Leave (CL)</th>
              <th>Sick Leave (SL)</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Allotted Leave</td>
              <td>{allottedCL}</td>
              <td>{allottedSL}</td>
            </tr>
            <tr>
              <td>Used Leave</td>
              <td>{usedCL}</td>
              <td>{usedSL}</td>
            </tr>
            <tr>
              <td>Available Leave</td>
              <td>{availCL}</td>
              <td>{availSL}</td>
            </tr>
          </tbody>
        </table>
        <div className="paid-leave-note">
          Note: Each month, 0.5 days of Sick Leave and 0.5 days of Casual Leave are credited to your
          account. Advance leave is not provided. You can save your leave days to take them together.
        </div>
      </div>

      {/* My Leaves table */}
      <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginTop:16}}>
        <h3>My Leaves</h3>
        <button className="btn" onClick={()=>alert('Apply leave (future feature)')}>Apply Leave</button>
      </div>
      <div className="card">
        <table>
          <thead>
            <tr><th>From</th><th>To</th><th>Type</th><th>Status</th></tr>
          </thead>
          <tbody>
            {leaves.map((l,i)=>(
              <tr key={i}>
                <td>{l.start}</td>
                <td>{l.end}</td>
                <td>{l.type}</td>
                <td>{l.status}</td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  );
}

/* ------------ Weekly Agenda Tab (NEW) ------------ */
function WeeklyAgendaTab({weeklyAgenda}) {
  return (
    <div>
      <h3>Weekly Agenda</h3>
      <div className="card">
        <table>
          <thead>
            <tr>
              <th>Task No</th>
              <th>Task Details</th>
              <th>Assigner Email Id</th>
              <th>Assignee Email Id</th>
              <th>Initial Target Date</th>
              <th>Revised Target Date 1</th>
              <th>Revised Target Date 2</th>
              <th>Revised Target Date 3</th>
              <th>Revised Target Date 4</th>
              <th>Revised Target Date 5</th>
              <th>Submission Type</th>
              <th>Completion Status %</th>
              <th>Update Remarks</th>
              <th>Completion Date</th>
              <th>Verification Remarks</th>
              <th>Verified Completion Date</th>
              <th>Column1</th>
              <th>Update Link</th>
            </tr>
          </thead>
          <tbody>
            {weeklyAgenda.map((r,i)=>(
              <tr key={i}>
                <td>{r.taskNo}</td>
                <td>{r.taskDetails}</td>
                <td>{r.assignerEmail}</td>
                <td>{r.assigneeEmail}</td>
                <td>{r.initialTarget}</td>
                <td>{r.revised1}</td>
                <td>{r.revised2}</td>
                <td>{r.revised3}</td>
                <td>{r.revised4}</td>
                <td>{r.revised5}</td>
                <td>{r.submissionType}</td>
                <td>{r.completionPercent}</td>
                <td>{r.updateRemarks}</td>
                <td>{r.completionDate}</td>
                <td>{r.verificationRemarks}</td>
                <td>{r.verifiedCompletionDate}</td>
                <td>{r.column1}</td>
                <td>
                  {r.updateLink
                    ? <a href={r.updateLink} target="_blank" rel="noreferrer">Open</a>
                    : ''}
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  );
}

/* ------------ Profile Tab ------------ */
function ProfileTab({employee}) {
  if(!employee) {
    return <div className="card">Employee not found in Excel. Check Employees table for your email.</div>;
  }

  const initials = employee.name
    ? employee.name.split(' ').map(n=>n[0]).slice(0,2).join('')
    : '';

  return (
    <div>
      <div className="card" style={{display:'flex', gap:16, alignItems:'center'}}>
        <div style={{
          width:92,
          height:92,
          borderRadius:10,
          background:'#eef2ff',
          display:'flex',
          alignItems:'center',
          justifyContent:'center',
          fontWeight:700,
          fontSize:22,
          color:'var(--accent)',
          overflow:'hidden'
        }}>
          {employee.photoUrl ? (
            <img
              src={employee.photoUrl}
              alt={employee.name}
              style={{width:'100%',height:'100%',objectFit:'cover'}}
            />
          ) : (
            initials
          )}
        </div>
        <div>
          <div style={{fontSize:18,fontWeight:700}}>{employee.name}</div>
          <div className="muted">{employee.title || 'Employee'} • {employee.location || '—'}</div>
          <div style={{marginTop:8}} className="small">Email: {employee.email}</div>
          <div className="small">Employee ID: {employee.id}</div>
          {employee.mobile && (
            <div className="small">Mobile: {employee.mobile}</div>
          )}
          <div style={{marginTop:8}}>
            <strong>Leave Balance:</strong> {employee.leaveBalance} days
          </div>
        </div>
      </div>

      <div className="card">
        <h4>Quick Actions</h4>
        <div style={{display:'flex', gap:8, marginTop:8}}>
          <button className="btn" onClick={()=>alert('Mark attendance (future)')}>Mark Attendance</button>
          <button className="btn" style={{background:'#06b6d4'}} onClick={()=>alert('Apply leave (future)')}>Apply Leave</button>
        </div>
      </div>
    </div>
  );
}

/* ------------ App ------------ */
function App() {
  const [user, setUser] = useState(null);          // { email, name }
  const [activeTab, setActiveTab] = useState('Overview');
  const [employees, setEmployees] = useState([]);
  const [attendance, setAttendance] = useState([]);
  const [leaves, setLeaves] = useState([]);
  const [weeklyAgenda, setWeeklyAgenda] = useState([]); // NEW
  const [currentEmployee, setCurrentEmployee] = useState(null);
  const [leaveCalc, setLeaveCalc] = useState(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');

  function normalize(str) {
    return (str || '').toString().trim().toLowerCase();
  }

  async function handleMsSignIn() {
    try {
      setError('');
      await window.msalOneDrive.loginPopup();
      const account = window.msalOneDrive.getAccount();
      if (!account) {
        setError('Unable to get Microsoft account after login.');
        return;
      }
      const email =
        (account.username ||
         account.email ||
         (account.idTokenClaims && account.idTokenClaims.preferred_username) ||
         '').toLowerCase();

      const name = account.name || email;
      setUser({ email, name });
      setActiveTab('Overview');

      await loadLiveDataFor(email, normalize, {
        setLoading,
        setError,
        setEmployees,
        setCurrentEmployee,
        setAttendance,
        setLeaves,
        setWeeklyAgenda,
        setLeaveCalc
      });
    } catch (e) {
      console.error(e);
      setError('Microsoft sign-in failed. See console for details.');
    }
  }

  async function loadLiveDataFor(userEmail, normalizeFn, setters) {
    const {
      setLoading,
      setError,
      setEmployees,
      setCurrentEmployee,
      setAttendance,
      setLeaves,
      setWeeklyAgenda,
      setLeaveCalc
    } = setters;

    try {
      setLoading(true);
      setError("");

      const lowerEmail = normalizeFn(userEmail);
      let me = null;

      /* ===== 1) EMPLOYEES TABLE ===== */
      const empRows = await window.fetchOneDriveTable("employees").catch(() => null);

      if (empRows && empRows.length) {
        const mappedEmps = empRows.map((r) => {
          const id =
            r["Employee ID"] ||
            r.EmployeeID ||
            r.employeeId ||
            r["Employee Id"] ||
            null;

          const primaryEmail =
            r["Microsoft Email ID"] ||
            r["Microsoft Email"] ||
            r.MicrosoftEmailID ||
            null;

          const altEmail =
            r["Email address"] ||
            r["Email Address"] ||
            r.Email ||
            r.email ||
            null;

          return {
            id,
            name: r["Emp Name"] || r.EmpName || r.Name || "",
            email: (primaryEmail || altEmail || "").toString().trim(),
            primaryEmail: (primaryEmail || "").toString().trim(),
            altEmail: (altEmail || "").toString().trim(),
            title: "",
            location: "",
            leaveBalance: 0,
            photoUrl:
              r["Employee Photo"] ||
              r["EmployeePhoto"] ||
              r["Photo URL"] ||
              r.PhotoUrl ||
              null,
            doj: r.DOJ || r["DOJ"] || null,
            mobile: r.Mobile || r["Mobile"] || null
          };
        });

        me =
          mappedEmps.find(e => normalizeFn(e.primaryEmail) === lowerEmail) ||
          mappedEmps.find(e => normalizeFn(e.altEmail) === lowerEmail) ||
          null;

        setEmployees(mappedEmps);
        if (me) {
          me = { ...me, email: me.email || me.primaryEmail || me.altEmail };
          setCurrentEmployee(me);
        } else {
          console.warn(
            "No employee row matching email:",
            lowerEmail,
            "Check Employees table 'Microsoft Email ID' / 'Email address' columns."
          );
        }
      }

      const myId = me && me.id ? normalizeFn(me.id) : null;
      const myName = me && me.name ? normalizeFn(me.name) : null;

      /* ===== 2) ATTENDANCE TABLE ===== */
      const attRows = await window.fetchOneDriveTable("attendance").catch(() => null);
      if (attRows && attRows.length) {
        let mapped = attRows.map((r) => {
          const rawDate =
            r["Date"] ||
            r.Date ||
            "";

          const rawTimeIn =
            r["Time_In"] ||
            r["Check-IN Time"] ||
            r["Check In Time"] ||
            r.CheckINTime ||
            "";

          const rawTimeOut =
            r["Time_Out"] ||
            r["Check-Out Time"] ||
            r["Check Out Time"] ||
            r.CheckOutTime ||
            "";

          return {
            employeeEmail:
              r["Email ID"] ||
              r["Email"] ||
              r.EmailID ||
              r.Email ||
              "",
            name: r["Emp Name"] || r.EmpName || "",
            date: formatExcelDate(rawDate),
            dateObj: excelToJSDate(rawDate),
            day: r["Day"] || r.Day || "",
            status: r["Status"] || r.Status || "",
            timeIn: formatExcelTime(rawTimeIn),
            timeOut: formatExcelTime(rawTimeOut),
            lateHours:
              r["Late Hours"] ||
              r["Late Hour"] ||
              r.LateHours ||
              r["LateHours"] ||
              ""
          };
        });

        if (lowerEmail) {
          mapped = mapped.filter(
            (a) => normalizeFn(a.employeeEmail) === lowerEmail
          );
        }

        setAttendance(mapped);
      }

      /* ===== 3) LEAVES TABLE ===== */
      const leavesRows = await window.fetchOneDriveTable("leaves").catch(() => null);
      if (leavesRows && leavesRows.length) {
        let mapped = leavesRows.map((r) => ({
          employeeId:
            r["Employee Id"] ||
            r["Employee ID"] ||
            r.EmployeeId ||
            r.EmployeeID ||
            null,
          name: r["Name"] || r.Name || "",
          start: formatExcelDate(
            r["Start Date"] || r.StartDate || r.Start || ""
          ),
          end: formatExcelDate(
            r["End Date"] || r.EndDate || r.End || ""
          ),
          type: r["Leave Type"] || r.LeaveType || "",
          status: r["Approval Decision"] || r.ApprovalDecision || "",
          paidDays: r["Paid Days"] || r.PaidDays || ""
        }));

        if (myId) {
          mapped = mapped.filter(
            (l) => normalizeFn(l.employeeId) === myId
          );
        }

        setLeaves(mapped);
      }

      /* ===== 4) LEAVE CALCULATION TABLE ===== */
      const calcRows = await window.fetchOneDriveTable("Leave_Calculation").catch(() => null);
      if (calcRows && calcRows.length) {
        let myCalcRow =
          calcRows.find(r => normalizeFn(
            r["Employee Id"] || r["Employee ID"] || r.EmployeeId || ""
          ) === myId) || null;

        if (!myCalcRow && myName) {
          myCalcRow = calcRows.find(r => normalizeFn(r["Name"] || r.Name || "") === myName) || null;
        }

        if (myCalcRow) {
          const totalLeaves = Number(myCalcRow["Total Leaves"] || 0);
          const allottedCL = totalLeaves / 2;
          const allottedSL = totalLeaves / 2;
          const usedCL = Number(myCalcRow["Casual Leave (CL)"] || 0);
          const usedSL = Number(myCalcRow["Sick Leave (SL)"] || 0);
          const availCL = Math.max(0, allottedCL - usedCL);
          const availSL = Math.max(0, allottedSL - usedSL);

          setLeaveCalc({
            allottedCL,
            allottedSL,
            usedCL,
            usedSL,
            availCL,
            availSL
          });
        } else {
          setLeaveCalc(null);
        }
      } else {
        setLeaveCalc(null);
      }

      /* ===== 5) WEEKLY AGENDA TABLE ===== */
      const agendaRows = await window.fetchOneDriveTable("weeklyAgenda").catch(() => null);
      if (agendaRows && agendaRows.length) {
        let mapped = agendaRows.map(r => ({
          taskNo: r["Task No"] || r.TaskNo || "",
          taskDetails: r["Task Details"] || r.TaskDetails || "",
          assignerEmail: r["Assigner Email Id"] || r.AssignerEmailId || "",
          assigneeEmail: r["Assignee Email Id"] || r.AssigneeEmailId || "",
          initialTarget: formatExcelDate(r["Initial Target Date"] || r.InitialTargetDate || ""),
          revised1: formatExcelDate(r["Revised Target Date 1"] || r.RevisedTargetDate1 || ""),
          revised2: formatExcelDate(r["Revised Target Date 2"] || r.RevisedTargetDate2 || ""),
          revised3: formatExcelDate(r["Revised Target Date 3"] || r.RevisedTargetDate3 || ""),
          revised4: formatExcelDate(r["Revised Target Date 4"] || r.RevisedTargetDate4 || ""),
          revised5: formatExcelDate(r["Revised Target Date 5"] || r.RevisedTargetDate5 || ""),
          submissionType: r["Submission Type"] || r.SubmissionType || "",
          completionPercent: r["Completion Status %"] || r.CompletionStatus || "",
          updateRemarks: r["Update Remarks"] || r.UpdateRemarks || "",
          completionDate: formatExcelDate(r["Completion Date"] || r.CompletionDate || ""),
          verificationRemarks: r["Verification Remarks"] || r.VerificationRemarks || "",
          verifiedCompletionDate: formatExcelDate(r["Verified Completion Date"] || r.VerifiedCompletionDate || ""),
          column1: r["Column1"] || r.Column1 || "",
          updateLink: r["Update Link"] || r.UpdateLink || ""
        }));

        if (lowerEmail) {
          mapped = mapped.filter(
            a => normalizeFn(a.assigneeEmail) === lowerEmail
          );
        }

        setWeeklyAgenda(mapped);
      } else {
        setWeeklyAgenda([]);
      }

    } catch (err) {
      console.error("Live data load failed", err);
      setError("Error loading data from Excel. Check console for details.");
    } finally {
      setLoading(false);
    }
  }

  function handleLogout() {
    setUser(null);
    setCurrentEmployee(null);
    setEmployees([]);
    setAttendance([]);
    setLeaves([]);
    setWeeklyAgenda([]);
    setLeaveCalc(null);
    setActiveTab('Overview');
  }

  if (!user) {
    return <LoginPage onSignIn={handleMsSignIn} error={error} />;
  }

  const employee = currentEmployee || (employees.length ? employees[0] : null);

  return (
    <div className="app">
      <Sidebar current={activeTab} onSelect={setActiveTab} onLogout={handleLogout} user={user} />
      <div className="main">
        <div className="header">
          <div>
            <div style={{fontSize:22,fontWeight:700}}>Employee Dashboard — Personal View</div>
            <div className="muted">Data filtered for <strong>{user.email}</strong></div>
          </div>
          <div style={{display:'flex', gap:12, alignItems:'center'}}>
            {loading && <div className="small muted">Refreshing data…</div>}
          </div>
        </div>

        {activeTab === 'Overview' && <Overview attendance={attendance} leaves={leaves} />}
        {activeTab === 'Leaves' && <LeavesTab leaves={leaves} leaveCalc={leaveCalc} />}
        {activeTab === 'Weekly Agenda' && <WeeklyAgendaTab weeklyAgenda={weeklyAgenda} />}
        {activeTab === 'Profile' && <ProfileTab employee={employee} />}

        <footer>
          <div className="muted">
            Live data from OneDrive Excel — rows are restricted to your email account.
          </div>
        </footer>
      </div>
    </div>
  );
}

/* Render */
ReactDOM.createRoot(document.getElementById("root")).render(<App />);
</script>

</body>
</html>
