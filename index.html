<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Employee Dashboard - Global</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- MSAL (global) -->
  <script src="https://alcdn.msauth.net/browser/2.37.0/js/msal-browser.min.js"></script>

  <style>
    :root{
      --bg:#f6f8fb; --card:#ffffff; --muted:#64748b;
      --accent:#2563eb; --radius:14px;
    }
    html,body,#root{height:100%; margin:0; font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;}
    body{background:linear-gradient(180deg,#f8fbff 0%,var(--bg) 100%); color:#0f172a;}
    .app { display:flex; min-height:100vh; }

    .sidebar {
      width:220px; background:rgba(255,255,255,0.92);
      box-shadow: 8px 0 24px rgba(15,23,42,0.03);
      padding:20px; border-right:1px solid #eef2f7;
      position:sticky; top:0; height:100vh; box-sizing:border-box;
    }

    .logo { font-weight:700; font-size:18px; margin-bottom:18px; }
    .nav { margin-top:18px; display:flex; flex-direction:column; gap:6px; }
    .nav button {
      text-align:left; background:none; border:none;
      padding:10px 12px; border-radius:10px;
      cursor:pointer; color:#0f172a; font-weight:500;
    }
    .nav button:hover{ background:#f1f5f9; }
    .nav .active{
      background:linear-gradient(90deg, rgba(37,99,235,0.1), rgba(80,123,255,0.03));
      color:var(--accent);
    }

    .main { flex:1; padding:28px; box-sizing:border-box; }
    .header { display:flex; justify-content:space-between; align-items:center; margin-bottom:18px; }
    .kpi-row { display:flex; gap:12px; flex-wrap:wrap; }
    .kpi {
      background:var(--card); border-radius:12px;
      padding:16px; box-shadow: 0 6px 18px rgba(15,23,42,0.04);
      min-width:170px;
    }
    .kpi .label{ color:var(--muted); font-size:12px; }
    .kpi .value{ font-size:20px; font-weight:700; margin-top:6px; }

    .card {
      background:var(--card); border-radius:12px;
      padding:16px; box-shadow: 0 8px 28px rgba(15,23,42,0.03);
      margin-top:16px;
    }

    .row { display:flex; gap:12px; }
    .col-2 { display:flex; flex-direction:column; gap:12px; flex:1; }
    table { width:100%; border-collapse:collapse; margin-top:12px; }
    th, td {
      text-align:left; padding:10px 8px;
      border-bottom:1px solid #f1f5f9;
      font-size:14px;
    }

    .muted { color:var(--muted); font-size:13px; }
    .small { font-size:13px; color:var(--muted); }

    .btn {
      background:var(--accent); color:#fff;
      border:none; padding:8px 12px;
      border-radius:10px; cursor:pointer;
    }

    .btn-secondary {
      background:#e2e8f0;
      color:#0f172a;
    }

    .search {
      padding:8px 12px; border-radius:10px;
      border:1px solid #eef2f7; width:220px;
    }

    .login-wrap {
      min-height:100vh;
      display:flex; align-items:center; justify-content:center;
    }
    .login-card {
      width:420px; background:var(--card);
      padding:28px; border-radius:16px;
      box-shadow: 0 12px 40px rgba(15,23,42,0.06);
    }

    .tabbar { display:flex; gap:8px; margin-top:12px; }
    .tab {
      padding:8px 12px; border-radius:10px;
      background:#f8fafc; cursor:pointer;
      font-weight:600;
    }
    .tab.active {
      background:linear-gradient(90deg,#eef2ff,#fff);
      color:var(--accent);
      box-shadow:0 6px 18px rgba(37,99,235,0.06);
    }

    .link-btn { background:none; border:none; color:var(--accent); cursor:pointer; padding:0; font-weight:600; }
    footer { margin-top:24px; color:var(--muted); font-size:13px; }

    .profile-layout {
      display:flex;
      gap:24px;
      align-items:flex-start;
      flex-wrap:wrap;
    }
    .profile-photo-wrap {
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:8px;
    }
    .profile-photo {
      width:140px;
      height:140px;
      border-radius:50%;
      overflow:hidden;
      border:4px solid #e5e7eb;
      background:#e5e7eb;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:40px;
      font-weight:700;
      color:var(--accent);
    }
    .profile-photo img {
      width:100%;
      height:100%;
      object-fit:cover;
    }
    .profile-fields {
      flex:1;
      min-width:260px;
    }
    .profile-field-row {
      display:flex;
      padding:4px 0;
    }
    .profile-field-label {
      width:150px;
      font-weight:600;
      font-size:14px;
    }
    .profile-field-value {
      font-size:14px;
    }

    .profile-actions {
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
      gap:10px;
      margin-top:10px;
    }

    @media (max-width:900px){
      .sidebar{display:none;}
      .main{padding:14px;}
      .row{flex-direction:column;}
      .kpi{min-width:140px;}
    }
  </style>
</head>

<body>
<div id="root"></div>

<!-- ========= MSAL / GRAPH HELPER (NON-MODULE) ========= -->
<script>
  const CLIENT_ID    = "27917652-ca62-4409-b37c-e47df77bfce9";
  const TENANT_ID    = "93846c24-8666-4033-8b6e-901877a2cf98";
  const REDIRECT_URI = "https://gbslit.github.io/Employee_Dashboard/";
  const DRIVE_ID     = "b!btaPqJ-5kU-kkE4KEoaxo8fltt6l6xpLs60U3YTj_EAxQMgJa8fsSLceYscvhxNo";
  const FILE_ID      = "016GCLEJF6QPT4M3PLEFEITOFBJOBB4R2E";

  const TABLES = {
    employees:      "Employees",
    attendance:     "Attendance",
    leaves:         "Leaves",
    leaveCalc:      "Leave_Calculation",
    weeklyAgenda:   "Weekly_Agenda"
  };

  const msalConfig = {
    auth: {
      clientId: CLIENT_ID,
      authority: `https://login.microsoftonline.com/${TENANT_ID}`,
      redirectUri: REDIRECT_URI
    },
    cache: {
      cacheLocation: "localStorage",
      storeAuthStateInCookie: true
    }
  };

  const SCOPES = ["Files.Read.All","User.Read","Sites.Read.All"];

  const msalInstance = new msal.PublicClientApplication(msalConfig);

  async function getToken() {
    let account = msalInstance.getAllAccounts()[0];
    if (!account) {
      const loginResult = await msalInstance.loginPopup({ scopes: SCOPES });
      account = loginResult.account;
    }
    try {
      const tokenResponse = await msalInstance.acquireTokenSilent({
        scopes: SCOPES,
        account
      });
      return tokenResponse.accessToken;
    } catch (e) {
      const tokenResponse = await msalInstance.acquireTokenPopup({ scopes: SCOPES, account });
      return tokenResponse.accessToken;
    }
  }

  // Fetch Excel table and return array of objects
  window.fetchOneDriveTable = async function(tableKeyOrName) {
    const tableName = TABLES[tableKeyOrName] || tableKeyOrName;
    const token = await getToken();
    const base = `https://graph.microsoft.com/v1.0/drives/${DRIVE_ID}/items/${FILE_ID}/workbook`;

    // columns
    const colRes = await fetch(`${base}/tables/${encodeURIComponent(tableName)}/columns`, {
      headers: { Authorization: `Bearer ${token}` }
    });
    if(!colRes.ok) {
      const txt = await colRes.text().catch(()=> '');
      throw new Error("Columns fetch failed: " + colRes.status + " " + txt);
    }
    const colJson = await colRes.json();
    const columns = colJson.value.map(c => c.name);

    // rows
    const rowRes = await fetch(`${base}/tables/${encodeURIComponent(tableName)}/rows`, {
      headers: { Authorization: `Bearer ${token}` }
    });
    if(!rowRes.ok) {
      const txt = await rowRes.text().catch(()=> '');
      throw new Error("Rows fetch failed: " + rowRes.status + " " + txt);
    }
    const rowJson = await rowRes.json();
    const rows = (rowJson.value || []).map(r => {
      const vals = (r.values && r.values[0]) ? r.values[0] : [];
      const obj = {};
      for (let i=0; i<columns.length; i++) obj[columns[i]] = vals[i] ?? null;
      return obj;
    });
    return rows;
  };

  window.msalOneDrive = {
    msalInstance,
    async loginPopup() { return msalInstance.loginPopup({ scopes: SCOPES }); },
    getAccount() { return msalInstance.getAllAccounts()[0] || null; }
  };
</script>

<!-- React UMD -->
<script src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
<!-- Babel -->
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<script type="text/babel">
const { useState } = React;

/* ---------- Excel Date / Time Helpers ---------- */
function excelSerialToDate(value) {
  if (typeof value !== "number") return null;
  const base = new Date(Date.UTC(1899, 11, 30));
  return new Date(base.getTime() + value * 86400000);
}

function parseExcelLikeDate(value) {
  if (value === null || value === undefined || value === "") return null;
  if (typeof value === "number") return excelSerialToDate(value);
  const d = new Date(value);
  return isNaN(d.getTime()) ? null : d;
}

function formatExcelDate(value) {
  const d = parseExcelLikeDate(value);
  if (!d) {
    if (value === null || value === undefined) return "";
    return String(value);
  }
  return d.toLocaleDateString("en-GB", {
    day: "2-digit",
    month: "short",
    year: "numeric"
  });
}

function formatExcelTimeHMS(value) {
  if (value === null || value === undefined || value === "") return "";
  if (typeof value === "number") {
    const totalSeconds = Math.round(value * 24 * 60 * 60);
    const hours = Math.floor(totalSeconds / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    const seconds = totalSeconds % 60;
    return String(hours).padStart(2,"0") + ":" +
           String(minutes).padStart(2,"0") + ":" +
           String(seconds).padStart(2,"0");
  }
  return String(value);
}

/* ------------ Login Card ------------ */
function LoginPage({ onSignIn, error }) {
  return (
    <div className="login-wrap">
      <div className="login-card">
        <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:12}}>
          <div style={{fontSize:20,fontWeight:700}}>Employee Dashboard</div>
          <div style={{color:'var(--muted)',fontSize:13}}>Sign in with Microsoft 365</div>
        </div>

        <h2 style={{marginTop:6}}>Sign in</h2>
        <p className="small">
          Use your company email (Microsoft 365 account). Data will be filtered to your records only.
        </p>

        {error && (
          <div style={{color:'#dc2626',fontSize:13,marginTop:10}}>
            {error}
          </div>
        )}

        <div style={{marginTop:18}}>
          <button type="button" className="btn" onClick={onSignIn} style={{width:'100%'}}>
            Sign in with Microsoft 365
          </button>
        </div>

        <footer style={{marginTop:16}} className="small muted">
          Your email is only used to match your row in the Employees Excel table.
        </footer>
      </div>
    </div>
  );
}

/* ------------ Sidebar ------------ */
function Sidebar({ current, onSelect, onLogout, user }) {
  const tabs = ['Attendance','Leaves','Weekly Agenda','Profile'];
  return (
    <div className="sidebar">
      <div className="logo">Acme Corp</div>
      <div className="muted">Employee Dashboard</div>
      <div className="nav">
        {tabs.map(t=>(
          <button
            key={t}
            className={current===t ? 'active' : ''}
            onClick={()=>onSelect(t)}
          >
            {t}
          </button>
        ))}
      </div>
      <div style={{marginTop:'auto', marginBottom:8}} className="small muted">
        Signed in as <strong>{user?.name || user?.email || 'Employee'}</strong><br/>
        <span>{user?.email}</span>
      </div>
      <button onClick={onLogout} className="btn" style={{width:'100%'}}>Sign out</button>
    </div>
  );
}

function KPICard({label, value}) {
  return (
    <div className="kpi">
      <div className="label">{label}</div>
      <div className="value">{value}</div>
    </div>
  );
}

/* ------------ Attendance (Overview) Page ------------ */
function AttendancePage({allAttendance, leaves}) {
  const now = new Date();
  const currentMonth = now.getMonth();
  const currentYear = now.getFullYear();

  const currentMonthAttendance = allAttendance.filter(a =>
    a.jsDate &&
    a.jsDate.getMonth() === currentMonth &&
    a.jsDate.getFullYear() === currentYear
  );

  const prev = new Date(currentYear, currentMonth - 1, 1);
  const prevMonth = prev.getMonth();
  const prevYear = prev.getFullYear();

  const prevMonthAttendance = allAttendance.filter(a =>
    a.jsDate &&
    a.jsDate.getMonth() === prevMonth &&
    a.jsDate.getFullYear() === prevYear
  );

  const appliedLeavesCount = leaves.length;
  const approvedLeavesCount = leaves.filter(
    l => (l.status || '').toString().toLowerCase() === 'approved'
  ).length;

  return (
    <div>
      <div className="kpi-row">
        <KPICard label="My Attendance Records" value={currentMonthAttendance.length} />
        <KPICard label="Applied Leaves" value={appliedLeavesCount} />
        <KPICard label="Approved Leaves" value={approvedLeavesCount} />
      </div>

      <div className="row" style={{marginTop:12}}>
        <div className="col-2">
          <div className="card">
            <strong>{now.toLocaleDateString('en-GB',{month:'long', year:'numeric'})} Attendance</strong>
            <p className="muted">This month attendance records</p>
            <table>
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Day</th>
                  <th>Check In Time</th>
                  <th>Check Out Time</th>
                  <th>Late Hours</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                {currentMonthAttendance.map((r,i)=>(
                  <tr key={i}>
                    <td>{r.date}</td>
                    <td>{r.day}</td>
                    <td>{r.timeIn}</td>
                    <td>{r.timeOut}</td>
                    <td>{r.lateHours}</td>
                    <td>{r.status}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>

          <div className="card">
            <strong>
              {prev.toLocaleDateString('en-GB',{month:'long', year:'numeric'})} Attendance
            </strong>
            <p className="muted">Last month attendance records</p>
            <table>
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Day</th>
                  <th>Check In Time</th>
                  <th>Check Out Time</th>
                  <th>Late Hours</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                {prevMonthAttendance.map((r,i)=>(
                  <tr key={i}>
                    <td>{r.date}</td>
                    <td>{r.day}</td>
                    <td>{r.timeIn}</td>
                    <td>{r.timeOut}</td>
                    <td>{r.lateHours}</td>
                    <td>{r.status}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>

        <div style={{width:320}}>
          <div className="card">
            <strong>Summary</strong>
            <p className="muted">Quick view</p>
            <table>
              <tbody>
                <tr>
                  <td>Current month days</td>
                  <td>{currentMonthAttendance.length}</td>
                </tr>
                <tr>
                  <td>Last month days</td>
                  <td>{prevMonthAttendance.length}</td>
                </tr>
                <tr>
                  <td>Applied leaves</td>
                  <td>{appliedLeavesCount}</td>
                </tr>
                <tr>
                  <td>Approved leaves</td>
                  <td>{approvedLeavesCount}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  );
}

/* ------------ Leaves Page ------------ */
function LeavesTab({leaves, leaveCalc}) {
  const clAllotted = leaveCalc?.allottedCL ?? 0;
  const slAllotted = leaveCalc?.allottedSL ?? 0;
  const clUsed = leaveCalc?.usedCL ?? 0;
  const slUsed = leaveCalc?.usedSL ?? 0;
  const clAvail = leaveCalc?.availCL ?? (clAllotted - clUsed);
  const slAvail = leaveCalc?.availSL ?? (slAllotted - slUsed);

  return (
    <div>
      <h3>Paid Leave Calculation</h3>
      <div className="card">
        <table>
          <thead>
            <tr>
              <th style={{width:'20%'}}>Leave</th>
              <th>Casual Leave (CL)</th>
              <th>Sick Leave (SL)</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><strong>Allotted Leave</strong></td>
              <td>{clAllotted}</td>
              <td>{slAllotted}</td>
            </tr>
            <tr>
              <td><strong>Used Leave</strong></td>
              <td>{clUsed}</td>
              <td>{slUsed}</td>
            </tr>
            <tr>
              <td><strong>Available Leave</strong></td>
              <td>{clAvail}</td>
              <td>{slAvail}</td>
            </tr>
          </tbody>
        </table>
        <p style={{marginTop:10, fontSize:13, color:'#b91c1c'}}>
          <strong>Note:-</strong> Each month, 0.5 days of Sick Leave and 0.5 days of Casual Leave are credited to your account.
          Advance leave is not provided. You can save your leave days to take them together.
        </p>
      </div>

      <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginTop:16}}>
        <h3>My Leaves</h3>
        <button className="btn" onClick={()=>alert('Apply leave (future feature)')}>Apply Leave</button>
      </div>

      <div className="card">
        <table>
          <thead>
            <tr>
              <th>From</th>
              <th>To</th>
              <th>Applied Number of working days</th>
              <th>Status</th>
              <th>Approved Number of days</th>
            </tr>
          </thead>
          <tbody>
            {leaves.map((l,i)=>(
              <tr key={i}>
                <td>{l.start}</td>
                <td>{l.end}</td>
                <td>{l.appliedDays}</td>
                <td>{l.status}</td>
                <td>{l.approvedDays}</td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  );
}

/* ------------ Weekly Agenda Page ------------ */
function WeeklyAgendaTab({items}) {
  return (
    <div>
      <div style={{display:'flex', justifyContent:'space-between', alignItems:'center'}}>
        <h3>Weekly Agenda</h3>
      </div>
      <div className="card">
        <table>
          <thead>
            <tr>
              <th>Task No</th>
              <th>Task Details</th>
              <th>Assigner Email Id</th>
              <th>Assignee Email Id</th>
              <th>Initial Target Date</th>
              <th>Revised Target Date 1</th>
              <th>Revised Target Date 2</th>
              <th>Revised Target Date 3</th>
              <th>Revised Target Date 4</th>
              <th>Revised Target Date 5</th>
              <th>Submission Type</th>
              <th>Completion Status %</th>
              <th>Update Remarks</th>
              <th>Completion Date</th>
              <th>Verification Remarks</th>
              <th>Verified Completion Date</th>
              <th>Column1</th>
              <th>Update Link</th>
            </tr>
          </thead>
          <tbody>
            {items.map((r,i)=>(
              <tr key={i}>
                <td>{r.taskNo}</td>
                <td>{r.details}</td>
                <td>{r.assignerEmail}</td>
                <td>{r.assigneeEmail}</td>
                <td>{r.initialTarget}</td>
                <td>{r.rev1}</td>
                <td>{r.rev2}</td>
                <td>{r.rev3}</td>
                <td>{r.rev4}</td>
                <td>{r.rev5}</td>
                <td>{r.submissionType}</td>
                <td>{r.completionPercent}</td>
                <td>{r.updateRemarks}</td>
                <td>{r.completionDate}</td>
                <td>{r.verificationRemarks}</td>
                <td>{r.verifiedCompletionDate}</td>
                <td>{r.column1}</td>
                <td>
                  {r.updateLink
                    ? <a href={r.updateLink} target="_blank" rel="noopener noreferrer">Open</a>
                    : "-"}
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  );
}

/* ------------ Profile Page ------------ */
function ProfileTab({employee}) {
  if(!employee) {
    return <div className="card">Employee not found in Excel. Check Employees table for your email.</div>;
  }

  const initials = employee.name
    ? employee.name.split(' ').map(n=>n[0]).slice(0,2).join('')
    : '';

  const dojDisplay = employee.doj ? formatExcelDate(employee.doj) : "";
  const dobDisplay = employee.dob ? formatExcelDate(employee.dob) : "";

  return (
    <div>
      <div className="card">
        <div className="profile-layout">
          <div className="profile-photo-wrap">
            <div className="profile-photo">
              {employee.photoUrl ? (
                <img src={employee.photoUrl} alt={employee.name} />
              ) : (
                initials
              )}
            </div>
            {employee.awards && (
              <div className="small" style={{marginTop:8}}>
                <strong>Awards :</strong> {employee.awards}
              </div>
            )}
          </div>
          <div className="profile-fields">
            <div className="profile-field-row">
              <div className="profile-field-label">Emp ID</div>
              <div className="profile-field-value">{employee.id || "—"}</div>
            </div>
            <div className="profile-field-row">
              <div className="profile-field-label">Name</div>
              <div className="profile-field-value">{employee.name || "—"}</div>
            </div>
            <div className="profile-field-row">
              <div className="profile-field-label">DOJ</div>
              <div className="profile-field-value">{dojDisplay || "—"}</div>
            </div>
            <div className="profile-field-row">
              <div className="profile-field-label">Email Address</div>
              <div className="profile-field-value">{employee.email || "—"}</div>
            </div>
            <div className="profile-field-row">
              <div className="profile-field-label">Contact</div>
              <div className="profile-field-value">{employee.mobile || "—"}</div>
            </div>
            <div className="profile-field-row">
              <div className="profile-field-label">Department</div>
              <div className="profile-field-value">{employee.department || "—"}</div>
            </div>
            <div className="profile-field-row">
              <div className="profile-field-label">Designation</div>
              <div className="profile-field-value">{employee.designation || "—"}</div>
            </div>
            <div className="profile-field-row">
              <div className="profile-field-label">Skills & Expertise</div>
              <div className="profile-field-value">{employee.skills || "—"}</div>
            </div>
            <div className="profile-field-row">
              <div className="profile-field-label">Country</div>
              <div className="profile-field-value">{employee.country || "—"}</div>
            </div>
            <div className="profile-field-row">
              <div className="profile-field-label">Birth date</div>
              <div className="profile-field-value">{dobDisplay || "—"}</div>
            </div>
          </div>
        </div>
      </div>

      <div className="card">
        <h4>Quick Actions</h4>
        <div className="profile-actions">
          <button className="btn" onClick={()=>alert('Mark attendance (future)')}>Mark Attendance</button>
          <button className="btn" onClick={()=>alert('Apply leave (future)')}>Apply Leave</button>
          <button className="btn btn-secondary" onClick={()=>alert('IT Help Ticket (future)')}>IT Help Ticket</button>
          <button className="btn btn-secondary" onClick={()=>alert('Raise Hiring Request (future)')}>Raise Hiring Request</button>
          <button className="btn btn-secondary" onClick={()=>alert('GBSL Monthly Feedback (future)')}>GBSL Monthly Feedback</button>
          <button className="btn btn-secondary" onClick={()=>alert('Company Policies (future)')}>Company Policies</button>
        </div>
      </div>
    </div>
  );
}

/* ------------ App ------------ */
function App() {
  const [user, setUser] = useState(null);          // { email, name }
  const [activeTab, setActiveTab] = useState('Attendance');
  const [employees, setEmployees] = useState([]);
  const [attendance, setAttendance] = useState([]);
  const [leaves, setLeaves] = useState([]);
  const [leaveCalc, setLeaveCalc] = useState(null);
  const [weeklyAgenda, setWeeklyAgenda] = useState([]);
  const [currentEmployee, setCurrentEmployee] = useState(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');

  function normalize(str) {
    return (str || '').toString().trim().toLowerCase();
  }

  async function handleMsSignIn() {
    try {
      setError('');
      await window.msalOneDrive.loginPopup();
      const account = window.msalOneDrive.getAccount();
      if (!account) {
        setError('Unable to get Microsoft account after login.');
        return;
      }
      const email =
        (account.username ||
         account.email ||
         (account.idTokenClaims && account.idTokenClaims.preferred_username) ||
         '').toLowerCase();

      const name = account.name || email;
      setUser({ email, name });
      setActiveTab('Attendance');

      await loadLiveDataFor(email);
    } catch (e) {
      console.error(e);
      setError('Microsoft sign-in failed. See console for details.');
    }
  }

  async function loadLiveDataFor(userEmail) {
    try {
      setLoading(true);
      setError("");

      const lowerEmail = normalize(userEmail);
      let me = null;

      /* ===== 1) EMPLOYEES TABLE ===== */
      const empRows = await window.fetchOneDriveTable("employees").catch(() => null);

      if (empRows && empRows.length) {
        const mappedEmps = empRows.map((r) => {
          const id =
            r["Employee ID"] ||
            r.EmployeeID ||
            r.employeeId ||
            r["Employee Id"] ||
            null;

          const primaryEmail =
            r["Microsoft Email ID"] ||
            r["Microsoft Email"] ||
            r.MicrosoftEmailID ||
            null;

          const altEmail =
            r["Email address"] ||
            r["Email Address"] ||
            r.Email ||
            r.email ||
            null;

          return {
            id,
            name: r["Emp Name"] || r.EmpName || r.Name || "",
            email: (primaryEmail || altEmail || "").toString().trim(),
            primaryEmail: (primaryEmail || "").toString().trim(),
            altEmail: (altEmail || "").toString().trim(),
            title: "",
            location: "",
            leaveBalance: 0,
            photoUrl:
              r["Employee Photo"] ||
              r["EmployeePhoto"] ||
              r["Photo URL"] ||
              r.PhotoUrl ||
              null,
            doj: r.DOJ || r["DOJ"] || null,
            mobile: r.Mobile || r["Mobile"] || null,
            department: r["Department"] || "",
            designation: r["Designation"] || "",
            skills: r["Skills & Expertise"] || r["Skills"] || "",
            country: r["Country"] || "",
            dob: r["Birth date"] || r["DOB"] || null,
            awards: r["Awards"] || ""
          };
        });

        me =
          mappedEmps.find(e => normalize(e.primaryEmail) === lowerEmail) ||
          mappedEmps.find(e => normalize(e.altEmail) === lowerEmail) ||
          null;

        setEmployees(mappedEmps);
        if (me) {
          me = { ...me, email: me.email || me.primaryEmail || me.altEmail };
          setCurrentEmployee(me);
        } else {
          console.warn(
            "No employee row matching email:",
            lowerEmail,
            "Check Employees table 'Microsoft Email ID' / 'Email address' columns."
          );
        }
      }

      const myId = me && me.id ? normalize(me.id) : null;
      const myName = me && me.name ? normalize(me.name) : null;

      /* ===== 2) ATTENDANCE TABLE ===== */
      const attRows = await window.fetchOneDriveTable("attendance").catch(() => null);
      if (attRows && attRows.length) {
        let mapped = attRows.map((r) => {
          const rawDate =
            r["Date"] ||
            r.Date ||
            "";

          const jsDate = parseExcelLikeDate(rawDate);
          const displayDate = jsDate ? formatExcelDate(rawDate) : formatExcelDate(rawDate);
          const day = jsDate
            ? jsDate.toLocaleDateString("en-GB",{weekday:"short"})
            : "";

          const rawTimeIn =
            r["Time_In"] ||
            r["Check-IN Time"] ||
            r["Check In Time"] ||
            r.CheckINTime ||
            "";

          const rawTimeOut =
            r["Time_Out"] ||
            r["Check-Out Time"] ||
            r["Check Out Time"] ||
            r.CheckOutTime ||
            "";

          const rawLate =
            r["Late Hours"] ||
            r["Late_Hours"] ||
            r.LateHours ||
            "";

          return {
            employeeEmail:
              r["Email ID"] ||
              r["Email"] ||
              r.EmailID ||
              r.Email ||
              "",
            name: r["Emp Name"] || r.EmpName || "",
            jsDate,
            date: displayDate,
            day,
            status: r["Status"] || r.Status || "",
            timeIn: formatExcelTimeHMS(rawTimeIn),
            timeOut: formatExcelTimeHMS(rawTimeOut),
            lateHours: formatExcelTimeHMS(rawLate)
          };
        });

        if (lowerEmail) {
          mapped = mapped.filter(
            (a) => normalize(a.employeeEmail) === lowerEmail
          );
        }

        setAttendance(mapped);
      }

      /* ===== 3) LEAVES TABLE ===== */
      const leavesRows = await window.fetchOneDriveTable("leaves").catch(() => null);
      if (leavesRows && leavesRows.length) {
        let mapped = leavesRows.map((r) => ({
          employeeId:
            r["Employee Id"] ||
            r["Employee ID"] ||
            r.EmployeeId ||
            r.EmployeeID ||
            null,
          name: r["Name"] || r.Name || "",
          start: formatExcelDate(
            r["Start Date"] || r.StartDate || r.Start || ""
          ),
          end: formatExcelDate(
            r["End Date"] || r.EndDate || r.End || ""
          ),
          appliedDays: r["Applied Number of working days"] || r.AppliedNumberOfworkingdays || "",
          status: r["Approval Decision"] || r.ApprovalDecision || r.Status || "",
          approvedDays: r["Approved Number of days"] || r.ApprovedNumberOfdays || "",
        }));

        if (myId) {
          mapped = mapped.filter(
            (l) => normalize(l.employeeId) === myId
          );
        }

        setLeaves(mapped);
      }

      /* ===== 4) LEAVE CALCULATION TABLE ===== */
      const leaveCalcRows = await window.fetchOneDriveTable("leaveCalc").catch(() => null);
      if (leaveCalcRows && leaveCalcRows.length) {
        let row = leaveCalcRows.find(r => {
          const em =
            r["Microsoft Email ID"] ||
            r["Email address"] ||
            r["Email"] ||
            "";
          return normalize(em) === lowerEmail;
        }) || leaveCalcRows[0];

        if (row) {
          const totalLeaves = Number(row["Total Leaves"] || 0);
          const allotted = totalLeaves / 2;
          const clUsed = Number(row["Casual Leave (CL)"] || 0);
          const slUsed = Number(row["Sick Leave (SL)"] || 0);

          setLeaveCalc({
            allottedCL: allotted,
            allottedSL: allotted,
            usedCL: clUsed,
            usedSL: slUsed,
            availCL: allotted - clUsed,
            availSL: allotted - slUsed
          });
        }
      }

      /* ===== 5) WEEKLY AGENDA TABLE ===== */
      const weeklyRows = await window.fetchOneDriveTable("weeklyAgenda").catch(() => null);
      if (weeklyRows && weeklyRows.length) {
        let mapped = weeklyRows.map(r => ({
          taskNo: r["Task No"] || r.TaskNo || "",
          details: r["Task Details"] || r.TaskDetails || "",
          assignerEmail: r["Assigner Email Id"] || r.AssignerEmailId || "",
          assigneeEmail: r["Assignee Email Id"] || r.AssigneeEmailId || "",
          initialTarget: formatExcelDate(r["Initial Target Date"] || r.InitialTargetDate || ""),
          submissionType: r["Submission Type"] || r.SubmissionType || "",
          completionPercent: r["Completion Status %"] || r.CompletionStatus || "",
          updateRemarks: r["Update Remarks"] || r.UpdateRemarks || "",
          completionDate: formatExcelDate(r["Completion Date"] || r.CompletionDate || ""),
          verificationRemarks: r["Verification Remarks"] || r.VerificationRemarks || "",
          updateLink: r["Update Link"] || r.UpdateLink || ""
        }));

        if (lowerEmail) {
          mapped = mapped.filter(
            item => normalize(item.assigneeEmail) === lowerEmail
          );
        }

        setWeeklyAgenda(mapped);
      }

    } catch (err) {
      console.error("Live data load failed", err);
      setError("Error loading data from Excel. Check console for details.");
    } finally {
      setLoading(false);
    }
  }

  function handleLogout() {
    setUser(null);
    setCurrentEmployee(null);
    setEmployees([]);
    setAttendance([]);
    setLeaves([]);
    setLeaveCalc(null);
    setWeeklyAgenda([]);
    setActiveTab('Attendance');
  }

  if (!user) {
    return <LoginPage onSignIn={handleMsSignIn} error={error} />;
  }

  const employee = currentEmployee || (employees.length ? employees[0] : null);

  return (
    <div className="app">
      <Sidebar current={activeTab} onSelect={setActiveTab} onLogout={handleLogout} user={user} />
      <div className="main">
        <div className="header">
          <div>
            <div style={{fontSize:22,fontWeight:700}}>Employee Dashboard — Personal View</div>
            <div className="muted">Data filtered for <strong>{user.email}</strong></div>
          </div>
          <div style={{display:'flex', gap:12, alignItems:'center'}}>
            {loading && <div className="small muted">Refreshing data…</div>}
          </div>
        </div>

        {activeTab === 'Attendance' && (
          <AttendancePage allAttendance={attendance} leaves={leaves} />
        )}
        {activeTab === 'Leaves' && (
          <LeavesTab leaves={leaves} leaveCalc={leaveCalc} />
        )}
        {activeTab === 'Weekly Agenda' && (
          <WeeklyAgendaTab items={weeklyAgenda} />
        )}
        {activeTab === 'Profile' && (
          <ProfileTab employee={employee} />
        )}

        <footer>
          <div className="muted">
            Live data from OneDrive Excel — rows are restricted to your email account.
          </div>
        </footer>
      </div>
    </div>
  );
}

/* Render */
ReactDOM.createRoot(document.getElementById("root")).render(<App />);
</script>

</body>
</html>

