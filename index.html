<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Employee Dashboard - Internal</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      --bg: #f5f7fb;
      --card: #ffffff;
      --muted: #64748b;
      --accent: #2563eb;
      --accent-soft: #e0edff;
      --radius: 14px;
    }

    * { box-sizing: border-box; }

    html, body, #root {
      height: 100%;
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        Roboto, "Helvetica Neue", Arial, sans-serif;
    }

    body {
      background: radial-gradient(circle at top, #e5efff 0, #f5f7fb 42%, #edf1fb 100%);
      color: #0f172a;
    }

    .app {
      display: flex;
      min-height: 100vh;
    }

    .sidebar {
      width: 230px;
      background: rgba(255, 255, 255, 0.96);
      border-right: 1px solid #e2e8f0;
      box-shadow: 8px 0 24px rgba(15, 23, 42, 0.05);
      padding: 20px 18px;
      display: flex;
      flex-direction: column;
      position: sticky;
      top: 0;
      height: 100vh;
    }

    .logo {
      font-weight: 800;
      font-size: 20px;
      margin-bottom: 4px;
    }
    .logo-sub {
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 18px;
    }

    .nav {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 12px;
    }
    .nav button {
      text-align: left;
      padding: 9px 10px;
      border-radius: 10px;
      border: none;
      background: none;
      cursor: pointer;
      font-size: 14px;
      color: #0f172a;
      font-weight: 500;
    }
    .nav button:hover {
      background: #eef2ff;
    }
    .nav .active {
      background: linear-gradient(90deg, rgba(37, 99, 235, 0.10), rgba(37, 99, 235, 0.02));
      color: var(--accent);
    }

    .sidebar-footer {
      margin-top: auto;
      font-size: 12px;
      color: var(--muted);
    }

    .btn {
      background: var(--accent);
      color: #fff;
      border-radius: 999px;
      border: none;
      padding: 8px 14px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
    }
    .btn:hover { background: #1d4ed8; }

    .btn-outline {
      background: transparent;
      color: var(--accent);
      border-radius: 999px;
      border: 1px solid var(--accent-soft);
      padding: 7px 13px;
      font-size: 13px;
      cursor: pointer;
    }

    .main {
      flex: 1;
      padding: 26px 26px 28px;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 18px;
      gap: 18px;
    }

    .header-title {
      font-size: 24px;
      font-weight: 700;
    }

    .header-sub {
      color: var(--muted);
      font-size: 13px;
    }

    .kpi-row {
      display: flex;
      flex-wrap: wrap;
      gap: 14px;
      margin-bottom: 18px;
    }

    .kpi {
      background: var(--card);
      border-radius: 14px;
      padding: 14px 16px;
      box-shadow: 0 10px 28px rgba(15, 23, 42, 0.06);
      min-width: 180px;
      flex: 1;
    }
    .kpi-label {
      font-size: 12px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }
    .kpi-value {
      margin-top: 8px;
      font-size: 22px;
      font-weight: 700;
    }

    .row {
      display: flex;
      gap: 14px;
      margin-top: 8px;
    }

    .col {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .card {
      background: var(--card);
      border-radius: 14px;
      padding: 14px 16px;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.05);
    }

    .card-header {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .muted {
      color: var(--muted);
      font-size: 13px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 13px;
    }

    th, td {
      text-align: left;
      padding: 7px 4px;
      border-bottom: 1px solid #e5e7eb;
    }

    th {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: #6b7280;
    }

    tr:last-child td {
      border-bottom: none;
    }

    .search {
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid #e2e8f0;
      font-size: 13px;
      width: 220px;
    }

    .tabbar {
      display: flex;
      gap: 8px;
    }
    .tab {
      padding: 7px 12px;
      border-radius: 999px;
      background: #f3f4ff;
      font-size: 13px;
      cursor: pointer;
      font-weight: 500;
      color: #111827;
    }
    .tab.active {
      background: #e0ebff;
      color: var(--accent);
      box-shadow: 0 6px 14px rgba(37, 99, 235, 0.18);
    }

    .avatar {
      width: 92px;
      height: 92px;
      border-radius: 16px;
      background: #eef2ff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 28px;
      color: var(--accent);
      overflow: hidden;
    }
    .avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    footer {
      margin-top: 18px;
      font-size: 12px;
      color: var(--muted);
    }

    .login-wrap {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .login-card {
      width: 420px;
      background: var(--card);
      border-radius: 18px;
      padding: 26px 24px 22px;
      box-shadow: 0 20px 55px rgba(15, 23, 42, 0.16);
    }

    .small {
      font-size: 13px;
      color: var(--muted);
    }

    .login-title {
      font-size: 22px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .error {
      margin-top: 8px;
      font-size: 13px;
      color: #b91c1c;
    }

    .tag {
      display: inline-flex;
      align-items: center;
      padding: 4px 9px;
      border-radius: 999px;
      background: var(--accent-soft);
      color: var(--accent);
      font-size: 11px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    @media (max-width: 900px) {
      .sidebar { display: none; }
      .main { padding: 16px; }
      .row { flex-direction: column; }
      .kpi { min-width: 150px; }
    }
  </style>
</head>
<body>
<div id="root"></div>

<!-- MSAL browser (same CDN as PO dashboard) -->
<script src="https://alcdn.msauth.net/browser/2.37.0/js/msal-browser.min.js"></script>

<!-- Graph / Excel helpers (NON-module, uses global msal) -->
<script>
  // ====== YOUR CONFIG ======
  const CLIENT_ID    = "27917652-ca62-4409-b37c-e47df77bfce9";
  const TENANT_ID    = "93846c24-8666-4033-8b6e-901877a2cf98";
  const REDIRECT_URI = "https://gbslit.github.io/Employee_Dashboard/";
  const DRIVE_ID     = "b!btaPqJ-5kU-kkE4KEoaxo8fltt6l6xpLs60U3YTj_EAxQMgJa8fsSLceYscvhxNo";
  const FILE_ID      = "016GCLEJF6QPT4M3PLEFEITOFBJOBB4R2E";

  const TABLES = {
    employees: "Employees",
    attendance: "Attendance",
    leaves: "Leaves",
    payroll: "Payroll",
    htm: "HTM_LeaveCodes"
  };

  const msalInstance = new msal.PublicClientApplication({
    auth: {
      clientId: CLIENT_ID,
      authority: "https://login.microsoftonline.com/" + TENANT_ID,
      redirectUri: REDIRECT_URI
    },
    cache: { cacheLocation: "sessionStorage" }
  });

  const SCOPES = ["Files.Read.All", "User.Read", "Sites.Read.All"];

  async function getToken() {
    let account = msalInstance.getAllAccounts()[0];
    if (!account) {
      const loginResult = await msalInstance.loginPopup({ scopes: SCOPES });
      account = loginResult.account;
    }
    try {
      const result = await msalInstance.acquireTokenSilent({
        scopes: SCOPES,
        account
      });
      return result.accessToken;
    } catch (e) {
      const result = await msalInstance.acquireTokenPopup({
        scopes: SCOPES,
        account
      });
      return result.accessToken;
    }
  }

  window.fetchOneDriveTable = async function(tableKeyOrName) {
    const tableName = TABLES[tableKeyOrName] || tableKeyOrName;
    const token = await getToken();
    const base = "https://graph.microsoft.com/v1.0/drives/" + DRIVE_ID +
                 "/items/" + FILE_ID + "/workbook";

    const colRes = await fetch(
      base + "/tables/" + encodeURIComponent(tableName) + "/columns",
      { headers: { Authorization: "Bearer " + token } }
    );
    if (!colRes.ok) {
      const t = await colRes.text().catch(() => "");
      throw new Error("Columns fetch failed: " + colRes.status + " " + t);
    }
    const colJson = await colRes.json();
    const columns = (colJson.value || []).map(c => c.name);

    const rowRes = await fetch(
      base + "/tables/" + encodeURIComponent(tableName) + "/rows",
      { headers: { Authorization: "Bearer " + token } }
    );
    if (!rowRes.ok) {
      const t = await rowRes.text().catch(() => "");
      throw new Error("Rows fetch failed: " + rowRes.status + " " + t);
    }
    const rowJson = await rowRes.json();
    const rows = (rowJson.value || []).map(r => {
      const vals = (r.values && r.values[0]) ? r.values[0] : [];
      const obj = {};
      for (let i = 0; i < columns.length; i++) {
        obj[columns[i]] = vals[i] ?? null;
      }
      return obj;
    });
    return rows;
  };

  window.msalOneDrive = {
    msalInstance,
    async loginPopup() { return msalInstance.loginPopup({ scopes: SCOPES }); },
    getAccount() { return msalInstance.getAllAccounts()[0] || null; }
  };
</script>

<!-- React & Babel -->
<script src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<script type="text/babel">
const { useState, useEffect } = React;

/* ============ Helpers ============ */

const normalizeFn = (s) => (s || "").toString().trim().toLowerCase();

function formatExcelDate(raw) {
  if (raw === null || raw === undefined || raw === "") return "";
  if (typeof raw === "string" && isNaN(Number(raw))) return raw;

  const serial = Number(raw);
  if (!Number.isFinite(serial)) return String(raw);

  const base = new Date(Date.UTC(1899, 11, 30));
  base.setUTCDate(base.getUTCDate() + Math.floor(serial));

  const day = String(base.getUTCDate()).padStart(2, "0");
  const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
  const mon = months[base.getUTCMonth()];
  const year = base.getUTCFullYear();
  return `${day}-${mon}-${year}`;
}

function formatExcelTime(raw) {
  if (raw === null || raw === undefined || raw === "") return "";
  const n = Number(raw);
  if (!Number.isFinite(n)) return String(raw);

  const totalMinutes = Math.round(n * 24 * 60);
  const hours = Math.floor(totalMinutes / 60);
  const mins = totalMinutes % 60;
  return `${String(hours).padStart(2,"0")}:${String(mins).padStart(2,"0")}`;
}

function parseMoney(raw) {
  if (raw == null) return 0;
  const s = String(raw).replace(/[^0-9.-]/g, "");
  const n = Number(s);
  return Number.isFinite(n) ? n : 0;
}

/* ============ Login Screen ============ */

function LoginScreen({ onSignedIn, error, loading }) {
  async function handleSignIn() {
    await onSignedIn();
  }

  return (
    <div className="login-wrap">
      <div className="login-card">
        <div style={{display:"flex", justifyContent:"space-between", alignItems:"center", marginBottom:10}}>
          <div>
            <div className="login-title">Employee Dashboard</div>
            <div className="small">Sign in with your company Microsoft 365 account.</div>
          </div>
          <span className="tag">Sign in with Microsoft 365</span>
        </div>

        <p className="small" style={{marginTop:10}}>
          Use your <strong>@globalbasesourcing.com</strong> email. Data will be filtered so you only
          see your own attendance, leaves, and payroll records.
        </p>

        {error && (
          <div className="error">
            Microsoft sign-in failed. See console for details.
          </div>
        )}

        <button
          className="btn"
          style={{width:"100%", marginTop:18}}
          onClick={handleSignIn}
          disabled={loading}
        >
          {loading ? "Signing in…" : "Sign in with Microsoft 365"}
        </button>

        <p className="small" style={{marginTop:14}}>
          Your email is only used to match your row in the Employees Excel table.
        </p>
      </div>
    </div>
  );
}

/* ============ Layout Components ============ */

function Sidebar({ activeTab, setActiveTab, employee, onLogout }) {
  const tabs = ["Overview", "Attendance", "Leaves", "Payroll", "HTM Codes", "Profile"];
  const shortEmail = employee?.email || "";
  return (
    <aside className="sidebar">
      <div className="logo">Acme Corp</div>
      <div className="logo-sub">Employee Dashboard</div>

      <nav className="nav">
        {tabs.map((t) => (
          <button
            key={t}
            className={activeTab === t ? "active" : ""}
            onClick={() => setActiveTab(t)}
          >
            {t}
          </button>
        ))}
      </nav>

      <div className="sidebar-footer">
        <div style={{marginBottom:6}}>Signed in as <strong>GBSL IT</strong></div>
        <div>{shortEmail}</div>
        <button
          className="btn"
          style={{width:"100%", marginTop:12}}
          onClick={onLogout}
        >
          Sign out
        </button>
      </div>
    </aside>
  );
}

function KPICard({ label, value }) {
  return (
    <div className="kpi">
      <div className="kpi-label">{label}</div>
      <div className="kpi-value">{value}</div>
    </div>
  );
}

/* ============ Tabs ============ */

const DUMMY_HTM_CODES = [
  { code: "HTM010", description: "Full-Time Annual Leave", eligibility: "All FT employees" },
  { code: "HTM020", description: "Sick Leave", eligibility: "All employees" }
];

function OverviewTab({ attendance, leaves, payroll, employeeEmail }) {
  const pendingLeaves = leaves.filter(l =>
    (l.status || "").toLowerCase().includes("pending")
  ).length;

  return (
    <div>
      <div className="header">
        <div>
          <div className="header-title">Employee Dashboard — Personal View</div>
          <div className="header-sub">
            Data filtered for <strong>{employeeEmail}</strong>
          </div>
        </div>
      </div>

      <div className="kpi-row">
        <KPICard label="My Attendance Records" value={attendance.length} />
        <KPICard label="My Pending Leaves" value={pendingLeaves} />
        <KPICard label="My Payroll Entries" value={payroll.length} />
      </div>

      <div className="row">
        <div className="col">
          <div className="card">
            <div className="card-header">Attendance Snapshot</div>
            <div className="muted">Latest attendance records</div>
            <table>
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Status</th>
                  <th>Time In</th>
                  <th>Time Out</th>
                </tr>
              </thead>
              <tbody>
                {attendance.slice(0, 20).map((r, i) => (
                  <tr key={i}>
                    <td>{r.date}</td>
                    <td>{r.status}</td>
                    <td>{r.timeIn}</td>
                    <td>{r.timeOut}</td>
                  </tr>
                ))}
                {attendance.length === 0 && (
                  <tr><td colSpan="4" className="muted">No attendance records found.</td></tr>
                )}
              </tbody>
            </table>
          </div>

          <div className="card">
            <div className="card-header">Recent Leaves</div>
            <div className="muted">Your leave requests</div>
            <table>
              <thead>
                <tr>
                  <th>From</th>
                  <th>To</th>
                  <th>Type</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                {leaves.map((l, i) => (
                  <tr key={i}>
                    <td>{l.start}</td>
                    <td>{l.end}</td>
                    <td>{l.type}</td>
                    <td>{l.status}</td>
                  </tr>
                ))}
                {leaves.length === 0 && (
                  <tr><td colSpan="4" className="muted">No leave records found.</td></tr>
                )}
              </tbody>
            </table>
          </div>
        </div>

        <div style={{width:340}}>
          <div className="card">
            <div className="card-header">Payroll Summary</div>
            <div className="muted">Your payroll history</div>
            <table>
              <thead>
                <tr>
                  <th>Period</th>
                  <th>Net</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                {payroll.map((p, i) => (
                  <tr key={i}>
                    <td>{p.period}</td>
                    <td>{p.net}</td>
                    <td>{p.status}</td>
                  </tr>
                ))}
                {payroll.length === 0 && (
                  <tr><td colSpan="3" className="muted">No payroll entries.</td></tr>
                )}
              </tbody>
            </table>
          </div>

          <div className="card" style={{marginTop:14}}>
            <div className="card-header">HTM Codes</div>
            <div className="muted">Leave code mapping (static)</div>
            <table>
              <thead>
                <tr>
                  <th>Code</th>
                  <th>Desc</th>
                </tr>
              </thead>
              <tbody>
                {DUMMY_HTM_CODES.map((h, i) => (
                  <tr key={i}>
                    <td>{h.code}</td>
                    <td>{h.description}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  );
}

function AttendanceTab({ attendance }) {
  const [filter, setFilter] = useState("All");
  const [q, setQ] = useState("");

  const statuses = ["All", "Present", "OT", "LC", "WFH", "On Leave", "Absent"];

  const rows = attendance.filter(r => {
    const statusOk = filter === "All" || (r.status || "") === filter;
    const hay = ( (r.name || "") + " " +
                  (r.employeeEmail || "") + " " +
                  String(r.date || "")
                ).toLowerCase();
    const needle = q.toLowerCase();
    return statusOk && hay.includes(needle);
  });

  return (
    <div>
      <div className="header">
        <div>
          <div className="header-title">Attendance</div>
          <div className="header-sub">Search and filter your attendance records</div>
        </div>
        <div style={{display:"flex", gap:10, alignItems:"center"}}>
          <div className="tabbar">
            {statuses.map((s) => (
              <div
                key={s}
                className={"tab " + (filter === s ? "active" : "")}
                onClick={() => setFilter(s)}
              >
                {s}
              </div>
            ))}
          </div>
          <input
            className="search"
            placeholder="Search by date or status"
            value={q}
            onChange={(e) => setQ(e.target.value)}
          />
        </div>
      </div>

      <div className="card" style={{marginTop:12}}>
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Status</th>
              <th>Time In</th>
              <th>Time Out</th>
            </tr>
          </thead>
          <tbody>
            {rows.map((r, i) => (
              <tr key={i}>
                <td>{r.date}</td>
                <td>{r.status}</td>
                <td>{r.timeIn}</td>
                <td>{r.timeOut}</td>
              </tr>
            ))}
            {rows.length === 0 && (
              <tr><td colSpan="4" className="muted">No records match your filters.</td></tr>
            )}
          </tbody>
        </table>
      </div>
    </div>
  );
}

function LeavesTab({ leaves }) {
  return (
    <div>
      <div className="header">
        <div>
          <div className="header-title">Leaves</div>
          <div className="header-sub">Your leave applications and approvals</div>
        </div>
        <button className="btn-outline" onClick={() => alert("Apply leave (demo)")}>
          Apply Leave
        </button>
      </div>
      <div className="card">
        <table>
          <thead>
            <tr>
              <th>From</th>
              <th>To</th>
              <th>Type</th>
              <th>Paid Days</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            {leaves.map((l, i) => (
              <tr key={i}>
                <td>{l.start}</td>
                <td>{l.end}</td>
                <td>{l.type}</td>
                <td>{l.paidDays}</td>
                <td>{l.status}</td>
              </tr>
            ))}
            {leaves.length === 0 && (
              <tr><td colSpan="5" className="muted">No leave records.</td></tr>
            )}
          </tbody>
        </table>
      </div>
    </div>
  );
}

function PayrollTab({ payroll }) {
  return (
    <div>
      <div className="header">
        <div>
          <div className="header-title">Payroll</div>
          <div className="header-sub">Your payroll history</div>
        </div>
      </div>
      <div className="card">
        <table>
          <thead>
            <tr>
              <th>Pay Period</th>
              <th>Gross</th>
              <th>Net</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            {payroll.map((p, i) => (
              <tr key={i}>
                <td>{p.period}</td>
                <td>{p.gross}</td>
                <td>{p.net}</td>
                <td>{p.status}</td>
              </tr>
            ))}
            {payroll.length === 0 && (
              <tr><td colSpan="4" className="muted">No payroll records.</td></tr>
            )}
          </tbody>
        </table>
      </div>
    </div>
  );
}

function HTMTab() {
  return (
    <div>
      <div className="header">
        <div>
          <div className="header-title">HTM Codes</div>
          <div className="header-sub">Leave code configuration from Excel</div>
        </div>
      </div>
      <div className="card">
        <table>
          <thead>
            <tr>
              <th>Code</th>
              <th>Description</th>
              <th>Eligibility</th>
            </tr>
          </thead>
          <tbody>
            {DUMMY_HTM_CODES.map((h, i) => (
              <tr key={i}>
                <td>{h.code}</td>
                <td>{h.description}</td>
                <td>{h.eligibility}</td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  );
}

function ProfileTab({ employee }) {
  if (!employee) {
    return <div className="card">Employee record not found in Excel.</div>;
  }

  const initials = employee.name
    .split(" ")
    .filter(Boolean)
    .map((n) => n[0])
    .slice(0, 2)
    .join("");

  return (
    <div>
      <div className="header">
        <div>
          <div className="header-title">Employee Dashboard — Personal View</div>
          <div className="header-sub">
            Data filtered for <strong>{employee.email}</strong>
          </div>
        </div>
      </div>

      <div className="card" style={{display:"flex", gap:18, alignItems:"center"}}>
        <div className="avatar">
          {employee.photoUrl ? (
            <img src={employee.photoUrl} alt={employee.name} />
          ) : (
            initials
          )}
        </div>
        <div>
          <div style={{fontSize:20, fontWeight:700}}>{employee.name}</div>
          <div className="muted">Employee • —</div>
          <div style={{marginTop:8}} className="small">
            Email: {employee.email}
          </div>
          {employee.id && (
            <div className="small">Employee ID: {employee.id}</div>
          )}
          {employee.mobile && (
            <div className="small">Mobile: {employee.mobile}</div>
          )}
          <div style={{marginTop:10}}>
            <strong>Leave Balance:</strong> {employee.leaveBalance || 0} days
          </div>
        </div>
      </div>

      <div className="card" style={{marginTop:14}}>
        <div className="card-header">Quick Actions</div>
        <div style={{display:"flex", gap:10, marginTop:8}}>
          <button className="btn" onClick={() => alert("Mark attendance (demo)")}>
            Mark Attendance
          </button>
          <button
            className="btn"
            style={{background:"#06b6d4"}}
            onClick={() => alert("Apply leave (demo)")}
          >
            Apply Leave
          </button>
        </div>
      </div>
    </div>
  );
}

/* ============ Main App ============ */

function App() {
  const [account, setAccount] = useState(null);
  const [employee, setEmployee] = useState(null);
  const [attendance, setAttendance] = useState([]);
  const [leaves, setLeaves] = useState([]);
  const [payroll, setPayroll] = useState([]);
  const [activeTab, setActiveTab] = useState("Overview");
  const [loading, setLoading] = useState(false);
  const [loginError, setLoginError] = useState("");

  async function handleMsSignIn() {
    setLoginError("");
    setLoading(true);
    try {
      const res = await window.msalOneDrive.loginPopup();
      const acc = window.msalOneDrive.getAccount() || res.account;
      setAccount(acc);
      await loadLiveDataForAccount(acc);
    } catch (e) {
      console.error(e);
      setLoginError("Microsoft sign-in failed. See console for details.");
    } finally {
      setLoading(false);
    }
  }

  async function loadLiveDataForAccount(acc) {
    if (!acc) return;
    const email = acc.username || acc.userName || "";
    const lowerEmail = normalizeFn(email);

    try {
      const empRows = await window.fetchOneDriveTable("employees").catch(() => []);
      let employeesMapped = empRows.map((r) => {
        const excelEmail = r["Email address"] || r["Email"] || r["Email ID"] || r.Email || "";
        const msEmail = r["Microsoft Email ID"] || r["Microsoft Email"] || "";
        return {
          id: r["Employee ID"] || r["Employee Id"] || r["EmployeeId"] || r.EmployeeID || "",
          name: r["Emp Name"] || r["Name"] || "",
          email: excelEmail || msEmail || email,
          excelEmail,
          msEmail,
          mobile: r["Mobile"] || r["Phone"] || r["EmployeePh"] || "",
          photoUrl: r["Photo URL"] || r["Employee Photo"] || r["EmployeePhoto"] || null,
          leaveBalance: r["Leave Balance"] || r["LeaveBalance"] || 0
        };
      });

      let current = employeesMapped.find(
        (e) =>
          normalizeFn(e.msEmail) === lowerEmail ||
          normalizeFn(e.excelEmail) === lowerEmail
      );

      if (!current) {
        current = {
          id: "",
          name: email,
          email,
          excelEmail: email,
          msEmail: email,
          mobile: "",
          leaveBalance: 0,
          photoUrl: null
        };
      }

      setEmployee(current);

      const attRows = await window.fetchOneDriveTable("attendance").catch(() => []);
      let attendanceMapped = attRows.map((r) => ({
        employeeEmail: r["Email ID"] || r["Email"] || r.EmailID || r.Email || "",
        name: r["Emp Name"] || r["Name"] || "",
        date: formatExcelDate(r["Date"] ?? r.Date ?? ""),
        status: r["Status"] || r.Status || "",
        timeIn: formatExcelTime(
          r["Check-IN Time"] ?? r["Check In Time"] ?? r.CheckINTime ?? ""
        ),
        timeOut: formatExcelTime(
          r["Check-Out Time"] ?? r["Check Out Time"] ?? r.CheckOutTime ?? ""
        )
      }));

      attendanceMapped = attendanceMapped.filter(
        (a) => normalizeFn(a.employeeEmail) === lowerEmail
      );
      setAttendance(attendanceMapped);

      const leavesRows = await window.fetchOneDriveTable("leaves").catch(() => []);
      let leavesMapped = leavesRows.map((r) => ({
        employeeId: r["Employee Id"] || r["Employee ID"] || r.EmployeeID || "",
        name: r["Name"] || r["Emp Name"] || "",
        start: formatExcelDate(r["Start Date"] ?? r["Start"] ?? r.start),
        end: formatExcelDate(r["End Date"] ?? r["End Data"] ?? r.end),
        type: r["Leave Type"] || r["Type"] || "",
        status: r["Approval Decision"] || r["Status"] || "",
        paidDays: r["Paid Days"] || r["PaidDays"] || ""
      }));

      const currentIdLower = normalizeFn(current.id);
      const currentNameLower = normalizeFn(current.name);
      leavesMapped = leavesMapped.filter((l) => {
        const idLower = normalizeFn(l.employeeId);
        const nameLower = normalizeFn(l.name);
        return (
          (currentIdLower && idLower === currentIdLower) ||
          (currentNameLower && nameLower === currentNameLower)
        );
      });
      setLeaves(leavesMapped);

      const payrollRows = await window.fetchOneDriveTable("payroll").catch(() => []);
      let payrollMapped = payrollRows.map((r) => ({
        employeeName: r["Employee"] || r["Emp Name"] || r.Name || "",
        period: r["Pay Period"] || r["Period"] || "",
        gross: parseMoney(r["Gross"] ?? r.Gross ?? 0),
        net: parseMoney(r["Net"] ?? r.Net ?? 0),
        status: r["Status"] || r.Status || ""
      }));

      payrollMapped = payrollMapped.filter(
        (p) => normalizeFn(p.employeeName) === normalizeFn(current.name)
      );

      setPayroll(
        payrollMapped.map((p) => ({
          ...p,
          gross: p.gross.toLocaleString("en-US"),
          net: p.net.toLocaleString("en-US")
        }))
      );
    } catch (err) {
      console.error("Live data load failed", err);
      setLoginError("Error loading data from Excel. See console for details.");
    }
  }

  function handleLogout() {
    window.msalOneDrive.msalInstance.logoutPopup().catch(console.error);
    setAccount(null);
    setEmployee(null);
    setAttendance([]);
    setLeaves([]);
    setPayroll([]);
    setActiveTab("Overview");
  }

  useEffect(() => {
    if (!window.msalOneDrive) return;
    const acc = window.msalOneDrive.getAccount();
    if (acc && !account) {
      setAccount(acc);
      loadLiveDataForAccount(acc);
    }
  }, []);

  if (!account || !employee) {
    return (
      <LoginScreen
        onSignedIn={handleMsSignIn}
        error={loginError}
        loading={loading}
      />
    );
  }

  return (
    <div className="app">
      <Sidebar
        activeTab={activeTab}
        setActiveTab={setActiveTab}
        employee={employee}
        onLogout={handleLogout}
      />
      <main className="main">
        {activeTab === "Overview" && (
          <OverviewTab
            attendance={attendance}
            leaves={leaves}
            payroll={payroll}
            employeeEmail={employee.email}
          />
        )}
        {activeTab === "Attendance" && (
          <AttendanceTab attendance={attendance} />
        )}
        {activeTab === "Leaves" && <LeavesTab leaves={leaves} />}
        {activeTab === "Payroll" && <PayrollTab payroll={payroll} />}
        {activeTab === "HTM Codes" && <HTMTab />}
        {activeTab === "Profile" && <ProfileTab employee={employee} />}

        <footer>
          Live data from OneDrive Excel — rows are restricted to your email
          account.
        </footer>
      </main>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App />);
</script>
</body>
</html>
