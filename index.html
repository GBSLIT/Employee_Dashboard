<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Employee Dashboard - Demo</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- MSAL (global) -->
  <script src="https://alcdn.msauth.net/browser/2.37.0/js/msal-browser.min.js"></script>

  <style>
    :root{
      --bg:#f6f8fb; --card:#ffffff; --muted:#64748b;
      --accent:#2563eb; --radius:14px;
    }
    html,body,#root{height:100%; margin:0; font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;}
    body{background:linear-gradient(180deg,#f8fbff 0%,var(--bg) 100%); color:#0f172a;}
    .app { display:flex; min-height:100vh; }

    .sidebar {
      width:220px; background:rgba(255,255,255,0.92);
      box-shadow: 8px 0 24px rgba(15,23,42,0.03);
      padding:20px; border-right:1px solid #eef2f7;
      position:sticky; top:0; height:100vh; box-sizing:border-box;
    }

    .logo { font-weight:700; font-size:18px; margin-bottom:18px; }
    .nav { margin-top:18px; display:flex; flex-direction:column; gap:6px; }
    .nav button {
      text-align:left; background:none; border:none;
      padding:10px 12px; border-radius:10px;
      cursor:pointer; color:#0f172a; font-weight:500;
    }
    .nav button:hover{ background:#f1f5f9; }
    .nav .active{
      background:linear-gradient(90deg, rgba(37,99,235,0.1), rgba(80,123,255,0.03));
      color:var(--accent);
    }

    .main { flex:1; padding:28px; box-sizing:border-box; }
    .header { display:flex; justify-content:space-between; align-items:center; margin-bottom:18px; }
    .kpi-row { display:flex; gap:12px; flex-wrap:wrap; }
    .kpi {
      background:var(--card); border-radius:12px;
      padding:16px; box-shadow: 0 6px 18px rgba(15,23,42,0.04);
      min-width:170px;
    }
    .kpi .label{ color:var(--muted); font-size:12px; }
    .kpi .value{ font-size:20px; font-weight:700; margin-top:6px; }

    .card {
      background:var(--card); border-radius:12px;
      padding:16px; box-shadow: 0 8px 28px rgba(15,23,42,0.03);
      margin-top:16px;
    }

    .row { display:flex; gap:12px; }
    .col-2 { display:flex; flex-direction:column; gap:12px; flex:1; }
    table { width:100%; border-collapse:collapse; margin-top:12px; }
    th, td {
      text-align:left; padding:10px 8px;
      border-bottom:1px solid #f1f5f9;
      font-size:14px;
    }

    .muted { color:var(--muted); font-size:13px; }

    .btn {
      background:var(--accent); color:#fff;
      border:none; padding:8px 12px;
      border-radius:10px; cursor:pointer;
    }

    .search {
      padding:8px 12px; border-radius:10px;
      border:1px solid #eef2f7; width:220px;
    }

    .login-wrap {
      min-height:100vh;
      display:flex; align-items:center; justify-content:center;
    }
    .login-card {
      width:420px; background:var(--card);
      padding:28px; border-radius:16px;
      box-shadow: 0 12px 40px rgba(15,23,42,0.06);
    }
    .field { display:flex; flex-direction:column; gap:6px; margin-bottom:12px; }
    .small { font-size:13px; color:var(--muted); }

    .tabbar { display:flex; gap:8px; margin-top:12px; }
    .tab {
      padding:8px 12px; border-radius:10px;
      background:#f8fafc; cursor:pointer;
      font-weight:600;
    }
    .tab.active {
      background:linear-gradient(90deg,#eef2ff,#fff);
      color:var(--accent);
      box-shadow:0 6px 18px rgba(37,99,235,0.06);
    }

    .link-btn { background:none; border:none; color:var(--accent); cursor:pointer; padding:0; font-weight:600; }
    footer { margin-top:24px; color:var(--muted); font-size:13px; }

    .notice { font-size:13px; color:#065f46; background:#ecfdf5; padding:8px 10px; border-radius:8px; border:1px solid #bbf7d0; margin-top:8px; }

    @media (max-width:900px){
      .sidebar{display:none;}
      .main{padding:14px;}
      .row{flex-direction:column;}
      .kpi{min-width:140px;}
    }
  </style>
</head>

<body>
<div id="root"></div>

<!-- MSAL / Graph helper (non-module) -->
<script>
  /* ========= YOUR VALUES ========= */
  const CLIENT_ID   = "27917652-ca62-4409-b37c-e47df77bfce9";
  const TENANT_ID   = "93846c24-8666-4033-8b6e-901877a2cf98";
  const REDIRECT_URI= "https://gbslit.github.io/Employee_Dashboard/";
  const DRIVE_ID    = "b!btaPqJ-5kU-kkE4KEoaxo8fltt6l6xpLs60U3YTj_EAxQMgJa8fsSLceYscvhxNo";
  const FILE_ID     = "016GCLEJF6QPT4M3PLEFEITOFBJOBB4R2E";

  const TABLES = {
    employees:  "Employees",
    attendance: "Attendance",
    leaves:     "Leaves",
    payroll:    "Payroll",
    htm:        "HTM_LeaveCodes"
  };

  const msalConfig = {
    auth: {
      clientId: CLIENT_ID,
      authority: `https://login.microsoftonline.com/${TENANT_ID}`,
      redirectUri: REDIRECT_URI
    },
    cache: {
      cacheLocation: "localStorage",
      storeAuthStateInCookie: true
    }
  };

  const SCOPES = ["Files.Read.All","User.Read","Sites.Read.All"];

  const msalInstance = new msal.PublicClientApplication(msalConfig);

  async function getToken() {
    let account = msalInstance.getAllAccounts()[0];
    if (!account) {
      const loginResult = await msalInstance.loginPopup({ scopes: SCOPES });
      account = loginResult.account;
    }
    try {
      const tokenResponse = await msalInstance.acquireTokenSilent({
        scopes: SCOPES,
        account
      });
      return tokenResponse.accessToken;
    } catch (e) {
      const tokenResponse = await msalInstance.acquireTokenPopup({ scopes: SCOPES, account });
      return tokenResponse.accessToken;
    }
  }

  // Fetch Excel table and return array of objects
  window.fetchOneDriveTable = async function(tableKeyOrName) {
    const tableName = TABLES[tableKeyOrName] || tableKeyOrName;
    const token = await getToken();
    const base = `https://graph.microsoft.com/v1.0/drives/${DRIVE_ID}/items/${FILE_ID}/workbook`;

    // columns
    const colRes = await fetch(`${base}/tables/${encodeURIComponent(tableName)}/columns`, {
      headers: { Authorization: `Bearer ${token}` }
    });
    if(!colRes.ok) {
      const txt = await colRes.text().catch(()=> '');
      throw new Error("Columns fetch failed: " + colRes.status + " " + txt);
    }
    const colJson = await colRes.json();
    const columns = colJson.value.map(c => c.name);

    // rows
    const rowRes = await fetch(`${base}/tables/${encodeURIComponent(tableName)}/rows`, {
      headers: { Authorization: `Bearer ${token}` }
    });
    if(!rowRes.ok) {
      const txt = await rowRes.text().catch(()=> '');
      throw new Error("Rows fetch failed: " + rowRes.status + " " + txt);
    }
    const rowJson = await rowRes.json();
    const rows = (rowJson.value || []).map(r => {
      const vals = (r.values && r.values[0]) ? r.values[0] : [];
      const obj = {};
      for (let i=0; i<columns.length; i++) obj[columns[i]] = vals[i] ?? null;
      return obj;
    });
    return rows;
  };

  window.msalOneDrive = {
    msalInstance,
    async loginPopup() { return msalInstance.loginPopup({ scopes: SCOPES }); },
    getAccount() { return msalInstance.getAllAccounts()[0] || null; }
  };
</script>

<!-- React UMD -->
<script src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
<!-- Babel -->
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<script type="text/babel">
const { useState } = React;

/* ----------------- Login page ----------------- */
function LoginPage({ onSignIn, error }) {
  return (
    <div className="login-wrap">
      <div className="login-card">
        <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:12}}>
          <div style={{fontSize:20,fontWeight:700}}>Employee Dashboard</div>
          <div style={{color:'var(--muted)',fontSize:13}}>Sign in with Microsoft 365</div>
        </div>

        <h2 style={{marginTop:6}}>Sign in</h2>
        <p className="small">Use your company email (Microsoft 365 account). Data will be filtered to your records only.</p>

        {error && <div style={{color:'#dc2626',fontSize:13,marginTop:10}}>{error}</div>}

        <div style={{marginTop:18}}>
          <button type="button" className="btn" onClick={onSignIn} style={{width:'100%'}}>
            Sign in with Microsoft 365
          </button>
        </div>

        <footer style={{marginTop:16}} className="small muted">
          Your email is only used to match your row in the Employees Excel table.
        </footer>
      </div>
    </div>
  );
}

/* -------------- Sidebar & small components -------------- */
function Sidebar({ current, onSelect, onLogout, user }) {
  const tabs = ['Overview','Attendance','Leaves','Payroll','HTM Codes','Profile'];
  return (
    <div className="sidebar">
      <div className="logo">Acme Corp</div>
      <div className="muted">Employee Dashboard</div>
      <div className="nav">
        {tabs.map(t=>(
          <button key={t} className={current===t ? 'active' : ''} onClick={()=>onSelect(t)}>{t}</button>
        ))}
      </div>
      <div style={{marginTop:'auto', marginBottom:8}} className="small muted">
        Signed in as <strong>{user?.name || user?.email || 'Employee'}</strong><br />
        <span>{user?.email}</span>
      </div>
      <button onClick={onLogout} className="btn" style={{width:'100%'}}>Sign out</button>
    </div>
  );
}

function KPICard({label, value}) {
  return <div className="kpi"><div className="label">{label}</div><div className="value">{value}</div></div>;
}

/* -------------- Tabs -------------- */
function Overview({attendance, leaves, payroll}) {
  return (
    <div>
      <div className="kpi-row">
        <KPICard label="My Attendance Records" value={attendance.length} />
        <KPICard label="My Pending Leaves" value={leaves.filter(l=>l.status==='Pending').length} />
        <KPICard label="My Payroll Entries" value={payroll.length} />
      </div>

      <div className="row" style={{marginTop:12}}>
        <div className="col-2">
          <div className="card">
            <strong>Attendance Snapshot</strong>
            <p className="muted">Latest attendance records</p>
            <table><thead><tr><th>Date</th><th>Status</th><th>Time In</th><th>Time Out</th></tr></thead>
            <tbody>
              {attendance.map((r,i)=>(<tr key={i}><td>{r.date}</td><td>{r.status}</td><td>{r.timeIn}</td><td>{r.timeOut}</td></tr>))}
            </tbody></table>
          </div>

          <div className="card">
            <strong>Recent Leaves</strong>
            <p className="muted">Your leave requests</p>
            <table><thead><tr><th>From</th><th>To</th><th>Type</th><th>Status</th></tr></thead>
            <tbody>
              {leaves.map((l,i)=>(<tr key={i}><td>{l.start}</td><td>{l.end}</td><td>{l.type}</td><td>{l.status}</td></tr>))}
            </tbody></table>
          </div>
        </div>

        <div style={{width:320}}>
          <div className="card">
            <strong>Payroll Summary</strong>
            <p className="muted">Your payroll history</p>
            <table><thead><tr><th>Period</th><th>Net</th><th>Status</th></tr></thead>
            <tbody>{payroll.map((p,i)=>(<tr key={i}><td>{p.period}</td><td>${p.net}</td><td>{p.status}</td></tr>))}</tbody></table>
          </div>

          <div className="card" style={{marginTop:12}}>
            <strong>HTM Codes</strong>
            <p className="muted">Leave code mapping (static)</p>
            <table><thead><tr><th>Code</th><th>Desc</th></tr></thead>
            <tbody>
              <tr><td>HTM001</td><td>Annual Leave</td></tr>
              <tr><td>HTM002</td><td>Sick Leave</td></tr>
            </tbody></table>
          </div>
        </div>
      </div>
    </div>
  );
}

function AttendanceTab({attendance}) {
  const [filter, setFilter] = useState('All');
  const [q, setQ] = useState('');
  const rows = attendance.filter(r =>
    (filter==='All' || r.status===filter) &&
    (r.date || '').toLowerCase().includes(q.toLowerCase())
  );
  return (
    <div>
      <div style={{display:'flex', justifyContent:'space-between', alignItems:'center'}}>
        <div className="tabbar">
          {['All','Present','WFH','On Leave','Absent'].map(t=>(
            <div key={t} className={`tab ${t===filter?'active':''}`} onClick={()=>setFilter(t)}>{t}</div>
          ))}
        </div>
        <div>
          <input className="search" placeholder="Search by date" value={q} onChange={(e)=>setQ(e.target.value)} />
        </div>
      </div>

      <div className="card" style={{marginTop:12}}>
        <table>
          <thead><tr><th>Date</th><th>Status</th><th>In</th><th>Out</th></tr></thead>
          <tbody>
            {rows.map((r,i)=>(
              <tr key={i}>
                <td>{r.date}</td><td>{r.status}</td><td>{r.timeIn}</td><td>{r.timeOut}</td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  );
}

function LeavesTab({leaves}) {
  return (
    <div>
      <div style={{display:'flex', justifyContent:'space-between', alignItems:'center'}}>
        <h3>My Leaves</h3>
        <button className="btn" onClick={()=>alert('Open apply leave form (to be implemented)')}>Apply Leave</button>
      </div>
      <div className="card">
        <table>
          <thead><tr><th>From</th><th>To</th><th>Type</th><th>Status</th></tr></thead>
          <tbody>{leaves.map((l,i)=>(<tr key={i}><td>{l.start}</td><td>{l.end}</td><td>{l.type}</td><td>{l.status}</td></tr>))}</tbody>
        </table>
      </div>
    </div>
  );
}

function PayrollTab({payroll}) {
  return (
    <div>
      <div style={{display:'flex', justifyContent:'space-between', alignItems:'center'}}>
        <h3>Payroll</h3>
        <button className="btn" onClick={()=>alert('Run payroll (admin only – not implemented)')}>Run Payroll</button>
      </div>
      <div className="card">
        <table>
          <thead><tr><th>Pay Period</th><th>Gross</th><th>Net</th><th>Status</th></tr></thead>
          <tbody>{payroll.map((p,i)=>(<tr key={i}><td>{p.period}</td><td>${p.gross}</td><td>${p.net}</td><td>{p.status}</td></tr>))}</tbody>
        </table>
      </div>
    </div>
  );
}

function HTMTab() {
  return (
    <div>
      <h3>HTM Codes (Static)</h3>
      <div className="card">
        <table>
          <thead><tr><th>Code</th><th>Description</th><th>Eligibility</th></tr></thead>
          <tbody>
            <tr><td>HTM001</td><td>Full-Time Annual Leave</td><td>All FT employees</td></tr>
            <tr><td>HTM002</td><td>Sick Leave</td><td>All employees</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  );
}

function ProfileTab({employee}) {
  if(!employee) return <div className="card">Employee not found in Excel (check email column).</div>;

  const initials = employee.name
    ? employee.name.split(' ').map(n=>n[0]).slice(0,2).join('')
    : '';

  return (
    <div>
      <div className="card" style={{display:'flex', gap:16, alignItems:'center'}}>
        <div style={{
          width:92,
          height:92,
          borderRadius:10,
          background:'#eef2ff',
          display:'flex',
          alignItems:'center',
          justifyContent:'center',
          fontWeight:700,
          fontSize:22,
          color:'var(--accent)',
          overflow:'hidden'
        }}>
          {employee.photoUrl ? (
            <img
              src={employee.photoUrl}
              alt={employee.name}
              style={{width:'100%',height:'100%',objectFit:'cover'}}
            />
          ) : (
            initials
          )}
        </div>
        <div>
          <div style={{fontSize:18,fontWeight:700}}>{employee.name}</div>
          <div className="muted">{employee.title} • {employee.location}</div>
          <div style={{marginTop:8}} className="small">Email: {employee.email}</div>
          <div className="small">Employee ID: {employee.id}</div>
          <div style={{marginTop:8}}><strong>Leave Balance:</strong> {employee.leaveBalance} days</div>
        </div>
      </div>

      <div className="card">
        <h4>Quick Actions</h4>
        <div style={{display:'flex', gap:8, marginTop:8}}>
          <button className="btn" onClick={()=>alert('Mark attendance (to be implemented)')}>Mark Attendance</button>
          <button className="btn" style={{background:'#06b6d4'}} onClick={()=>alert('Apply leave (to be implemented)')}>Apply Leave</button>
        </div>
      </div>
    </div>
  );
}

/* ---------------------- App ---------------------- */
function App() {
  const [user, setUser] = useState(null);          // { email, name }
  const [activeTab, setActiveTab] = useState('Overview');
  const [employees, setEmployees] = useState([]);
  const [attendance, setAttendance] = useState([]);
  const [leaves, setLeaves] = useState([]);
  const [payroll, setPayroll] = useState([]);
  const [currentEmployee, setCurrentEmployee] = useState(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');

  function normalize(str) {
    return (str || '').toString().trim().toLowerCase();
  }

  async function handleMsSignIn() {
    try {
      setError('');
      await window.msalOneDrive.loginPopup();
      const account = window.msalOneDrive.getAccount();
      if (!account) {
        setError('Unable to get Microsoft account after login.');
        return;
      }
      const email =
        (account.username ||
         account.email ||
         (account.idTokenClaims && account.idTokenClaims.preferred_username) ||
         '').toLowerCase();

      const name = account.name || email;
      setUser({ email, name });
      setActiveTab('Overview');

      await loadLiveDataFor(email);
    } catch (e) {
      console.error(e);
      setError('Microsoft sign-in failed. See console for details.');
    }
  }

  async function loadLiveDataFor(userEmail) {
    try {
      setLoading(true);
      const lowerEmail = (userEmail || '').toLowerCase();
      let me = null;

      // EMPLOYEES
      const empRows = await window.fetchOneDriveTable('employees').catch(()=>null);
      if (empRows && empRows.length) {
        const mapped = empRows.map(r => ({
          id: r.employeeId || r.EmployeeID || r['Employee ID'] || r.id || r.ID,
          name: r.name || r.Name,
          email: r.email || r.Email || r['Work Email'] || r['Official Email'],
          title: r.title || r.Title || '',
          location: r.location || r.Location || '',
          leaveBalance: r.leaveBalance || r.LeaveBalance || r['Leave Balance'] || 0,
          photoUrl: r.photoUrl || r.PhotoUrl || r['Photo URL'] || r.Image || r.Photo || null
        }));

        me = mapped.find(e => normalize(e.email) === lowerEmail) || null;

        setEmployees(me ? [me] : mapped);
        setCurrentEmployee(me);
      }

      const myId = me && me.id ? normalize(me.id) : null;

      // ATTENDANCE
      const attRows = await window.fetchOneDriveTable('attendance').catch(()=>null);
      if (attRows && attRows.length) {
        let mapped = attRows.map(r => ({
          employeeId: r.employeeId || r.EmployeeID || r['Employee ID'] || r.id,
          name: r.name || r.Name,
          date: r.date || r.Date,
          status: r.status || r.Status,
          timeIn: r.timeIn || r.TimeIn || r['Time In'] || '-',
          timeOut: r.timeOut || r.TimeOut || r['Time Out'] || '-',
          email: r.email || r.Email || r['Work Email'] || r['Official Email']
        }));

        if (myId) {
          mapped = mapped.filter(a => normalize(a.employeeId) === myId);
        } else if (lowerEmail) {
          mapped = mapped.filter(a => normalize(a.email) === lowerEmail);
        }

        setAttendance(mapped);
      }

      // LEAVES
      const leavesRows = await window.fetchOneDriveTable('leaves').catch(()=>null);
      if (leavesRows && leavesRows.length) {
        let mapped = leavesRows.map(r => ({
          leaveId: r.leaveId || r.LeaveID || r['Leave ID'],
          employeeId: r.employeeId || r.EmployeeID || r['Employee ID'],
          name: r.name || r.Name,
          start: r.startDate || r.Start || r.start,
          end: r.endDate || r.End || r.end,
          type: r.type || r.Type,
          status: r.status || r.Status,
          email: r.email || r.Email || r['Work Email'] || r['Official Email'],
          htmCode: r.htmCode || r.HTMCode
        }));

        if (myId) {
          mapped = mapped.filter(l => normalize(l.employeeId) === myId);
        } else if (lowerEmail) {
          mapped = mapped.filter(l => normalize(l.email) === lowerEmail);
        }

        setLeaves(mapped);
      }

      // PAYROLL
      const payrollRows = await window.fetchOneDriveTable('payroll').catch(()=>null);
      if (payrollRows && payrollRows.length) {
        let mapped = payrollRows.map(r => ({
          employeeId: r.employeeId || r.EmployeeID || r['Employee ID'],
          name: r.name || r.Name,
          period: r.period || (r.payPeriodStart && r.payPeriodEnd ? `${r.payPeriodStart} - ${r.payPeriodEnd}` : r.period),
          gross: r.gross || r.Gross || 0,
          net: r.net || r.Net || 0,
          status: r.status || r.Status,
          email: r.email || r.Email || r['Work Email'] || r['Official Email']
        }));

        if (myId) {
          mapped = mapped.filter(p => normalize(p.employeeId) === myId);
        } else if (lowerEmail) {
          mapped = mapped.filter(p => normalize(p.email) === lowerEmail);
        }

        setPayroll(mapped);
      }
    } catch (err) {
      console.error('Live data load failed', err);
      setError('Error loading data from Excel. Check console for details.');
    } finally {
      setLoading(false);
    }
  }

  function handleLogout() {
    setUser(null);
    setCurrentEmployee(null);
    setEmployees([]);
    setAttendance([]);
    setLeaves([]);
    setPayroll([]);
    setActiveTab('Overview');
  }

  if (!user) {
    return <LoginPage onSignIn={handleMsSignIn} error={error} />;
  }

  const employee = currentEmployee || (employees.length ? employees[0] : null);

  return (
    <div className="app">
      <Sidebar current={activeTab} onSelect={setActiveTab} onLogout={handleLogout} user={user} />
      <div className="main">
        <div className="header">
          <div>
            <div style={{fontSize:22,fontWeight:700}}>Employee Dashboard — Personal View</div>
            <div className="muted">Data filtered for <strong>{user.email}</strong></div>
          </div>
          <div style={{display:'flex', gap:12, alignItems:'center'}}>
            {loading && <div className="small muted">Refreshing data…</div>}
          </div>
        </div>

        {activeTab === 'Overview' && <Overview attendance={attendance} leaves={leaves} payroll={payroll} />}
        {activeTab === 'Attendance' && <AttendanceTab attendance={attendance} />}
        {activeTab === 'Leaves' && <LeavesTab leaves={leaves} />}
        {activeTab === 'Payroll' && <PayrollTab payroll={payroll} />}
        {activeTab === 'HTM Codes' && <HTMTab />}
        {activeTab === 'Profile' && <ProfileTab employee={employee} />}

        <footer>
          <div className="muted">Live data from OneDrive Excel — rows are restricted to your email account.</div>
        </footer>
      </div>
    </div>
  );
}

/* Render */
ReactDOM.createRoot(document.getElementById("root")).render(<App />);
</script>

</body>
</html>
